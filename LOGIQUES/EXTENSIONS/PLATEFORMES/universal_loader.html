<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Mégastructure // {{ extension.name }}</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        /* --- Base Styles --- */
        html { font-size: calc(14px + 0.2vw); }
        body { margin: 0; font-family: 'Share Tech Mono', monospace; background-color: #0d0d0d; color: #00ffcc; overflow: hidden; font-size: 1rem; }
        .grime-Overlay, .moving-structure { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; }
        .grime-Overlay { background: url('/static/texture_grime.png') repeat; opacity: 0.08; z-index: -1; }
        .moving-structure { background: url('/static/structure_moving.png') center center / cover no-repeat; opacity: 0.05; animation: drift 60s infinite linear; z-index: -2; }
        @keyframes drift { 0% { transform: translate(0, 0) scale(1); } 50% { transform: translate(-1vw, 0.5vh) scale(1.05); } 100% { transform: translate(0, 0) scale(1); } }
        @keyframes glitch { 0%, 100% { text-shadow: 0.05em 0 red, -0.05em 0 blue; } 50% { text-shadow: -0.05em 0 red, 0.05em 0 blue; } }

        /* --- Layout --- */
        .loader-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            grid-template-rows: auto 1fr;
            grid-template-areas:
                "header header"
                "sidebar main";
            height: 100vh;
            padding: 2vh 2vw;
            box-sizing: border-box;
            gap: 1rem;
        }

        header {
            grid-area: header;
            text-align: center;
        }
        header h1 {
            font-size: 2rem;
            color: #ff33ff;
            margin: 0;
            animation: glitch 3s infinite;
        }

        .sidebar {
            grid-area: sidebar;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            background: rgba(0, 10, 8, 0.7);
            border: 1px solid rgba(0, 255, 204, 0.3);
            border-radius: 0.25rem;
            padding: 1rem;
            backdrop-filter: blur(5px);
        }

        .main-content {
            grid-area: main;
            background: #000;
            border: 1px solid rgba(0, 255, 204, 0.3);
            border-radius: 0.25rem;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
        }

        /* --- Sidebar Components --- */
        .control-panel, .log-panel, .command-panel, .quick-commands-panel {
            display: flex;
            flex-direction: column;
        }
        .log-panel { flex-grow: 1; }

        .sidebar h2 {
            font-size: 1.1rem;
            color: #ffff00;
            margin: 0 0 1rem 0;
            letter-spacing: 0.1em;
            border-bottom: 1px solid rgba(255, 255, 0, 0.3);
            padding-bottom: 0.5rem;
        }

        /* NOUVEAUX STYLES */
        .command-input-group {
            display: flex;
            gap: 0.5rem;
        }
        #command-input {
            flex-grow: 1;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(0, 255, 204, 0.3);
            color: #00ffcc;
            font-family: inherit;
            font-size: 0.9rem;
            padding: 0.5rem;
            border-radius: 0.2rem;
        }
        #command-input:disabled {
            background: rgba(0,0,0,0.2);
            border-color: rgba(0, 255, 204, 0.1);
            cursor: not-allowed;
        }
        #execute-btn {
            padding: 0.5rem 1rem;
            margin-bottom: 0; /* Override default margin */
            background: #ff33ff;
            color: #0d0d0d;
            border-color: #ff33ff;
        }
        #execute-btn:hover:not(:disabled) {
            box-shadow: 0 0 15px rgba(255, 51, 255, 0.7);
        }
        
        .quick-commands-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .quick-command-btn {
            background: transparent;
            color: #ff33ff;
            border-color: #ff33ff;
            text-align: left;
        }
        .quick-command-btn:hover:not(:disabled) {
            background: rgba(255, 51, 255, 0.1);
        }

        .action-btn {
            padding: 0.7rem 1rem;
            font-family: inherit;
            font-size: 0.9rem;
            cursor: pointer;
            border-radius: 0.25rem;
            transition: all 0.2s ease;
            border: 1px solid;
            margin-bottom: 0.5rem;
        }
        #start-btn { background: #00ffcc; color: #0d0d0d; border-color: #00ffcc; }
        #start-btn:hover { box-shadow: 0 0 15px rgba(0, 255, 204, 0.7); }
        #stop-btn { background: transparent; color: #ff5555; border-color: #ff5555; }
        #stop-btn:hover { background: rgba(255, 85, 85, 0.1); }
        .action-btn:disabled { background: #555; border-color: #555; color: #888; cursor: not-allowed; }

        #log-output {
            flex-grow: 1;
            background: rgba(0,0,0,0.3);
            padding: 0.5rem;
            font-size: 0.75rem;
            overflow-y: auto;
            border-radius: 0.2rem;
        }
        #log-output p { margin: 0 0 0.3rem 0; }

        /* --- VNC Screen --- */
        #vnc-screen {
            width: 100%;
            height: 100%;
            background: #000;
        }
        #vnc-status {
            position: absolute;
            color: rgba(255,255,255,0.5);
            font-size: 1.5rem;
            text-align: center;
            pointer-events: none;
        }

        #back-link {
            position: fixed;
            bottom: 2vh;
            right: 2vw;
            color: rgba(0, 255, 204, 0.6);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }
        #back-link:hover { color: #ff33ff; }

    </style>
</head>
<body>
    <div class="moving-structure"></div>
    <div class="grime-Overlay"></div>

    <div class="loader-container">
        <header>
            <h1>[ NIVEAU {{ extension.level }} // {{ extension.name }} ]</h1>
        </header>

        <aside class="sidebar">
            <div class="control-panel">
                <h2>Contrôle Sandbox</h2>
                <button id="start-btn" class="action-btn">Démarrer Sandbox</button>
                <button id="stop-btn" class="action-btn" disabled>Arrêter Sandbox</button>
            </div>
            <div class="command-panel">
                <h2>Exécution de Commande</h2>
                <div class="command-input-group">
                    <input type="text" id="command-input" placeholder="ex: xterm" disabled>
                    <button id="execute-btn" class="action-btn" disabled>Lancer</button>
                </div>
            </div>
            <div class="quick-commands-panel">
                <h2>Applications</h2>
                <div class="quick-commands-list">
                    <button class="quick-command-btn action-btn" data-command="xterm" disabled>Terminal</button>
                    <button class="quick-command-btn action-btn" data-command="firefox" disabled>Navigateur Web</button>
                    <button class="quick-command-btn action-btn" data-command="pcmanfm /data" disabled>Gestionnaire de Fichiers</button>
                </div>
            </div>
            <div class="log-panel">
                <h2>Journal d'activité</h2>
                <div id="log-output"></div>
            </div>
        </aside>

        <main class="main-content">
            <div id="vnc-screen"></div>
            <div id="vnc-status">SANDBOX DÉCONNECTÉE</div>
        </main>
    </div>

    <a id="back-link" href="/terminaux.html">[ RETOUR ]</a>

    <!-- NOUVEAU: Inclusion de noVNC depuis un CDN pour la simplicité. L'objet RFB sera global. -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noVNC/1.3.0/core/rfb.js"></script>

    <script>
        window.addEventListener('pywebviewready', () => {
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            const logOutput = document.getElementById('log-output');
            const vncScreen = document.getElementById('vnc-screen');
            const vncStatus = document.getElementById('vnc-status');
            const commandInput = document.getElementById('command-input');
            const executeBtn = document.getElementById('execute-btn');
            const quickCommandBtns = document.querySelectorAll('.quick-command-btn');

            let rfb; // noVNC instance
            let sandboxState = { isRunning: false, vncPort: null };

            // Placer addLog sur l'objet window pour qu'il soit accessible depuis Python
            window.addLog = function(message, type = 'info') {
                const p = document.createElement('p');
                // Le message de Python peut déjà contenir un préfixe
                const prefix = message.startsWith('[') || message.startsWith('>') ? '' : `[${new Date().toLocaleTimeString()}] `;
                p.textContent = `${prefix}${message}`;
                p.style.color = type === 'error' ? '#ff5555' : '#00ffcc';
                logOutput.appendChild(p);
                logOutput.scrollTop = logOutput.scrollHeight;
            };

            function updateUI() {
                const isRunning = sandboxState.isRunning;
                startBtn.disabled = isRunning;
                stopBtn.disabled = !isRunning;
                commandInput.disabled = !isRunning;
                executeBtn.disabled = !isRunning;
                quickCommandBtns.forEach(btn => btn.disabled = !isRunning);
                vncStatus.style.display = sandboxState.isRunning ? 'none' : 'block';
            }

            function connectVNC(port) {
                if (rfb) { rfb.disconnect(); }
                
                const host = window.location.hostname;
                const path = ''; // Le proxy websockify est à la racine du port

                window.addLog(`Tentative de connexion VNC à ws://${host}:${port}/`);
                
                try {
                    rfb = new RFB(vncScreen, `ws://${host}:${port}/${path}`, {
                        credentials: { password: 'megastructure' }
                    });

                    rfb.addEventListener("connect", () => {
                        window.addLog("Connexion VNC établie.");
                        vncStatus.style.display = 'none';
                    });

                    rfb.addEventListener("disconnect", (e) => {
                        window.addLog(`Déconnexion VNC. Raison: ${e.detail.clean ? 'propre' : 'inattendue'}.`, 'error');
                        sandboxState.isRunning = false;
                        updateUI();
                    });

                    rfb.scaleViewport = true;
                    rfb.resizeSession = true;

                } catch (exc) {
                    window.addLog(`Erreur de connexion VNC: ${exc}`, 'error');
                }
            }

            function disconnectVNC() {
                if (rfb) {
                    rfb.disconnect();
                    rfb = null;
                    window.addLog("Client VNC déconnecté.");
                }
            }

            startBtn.addEventListener('click', () => {
                window.addLog("Demande de démarrage de la sandbox...");
                startBtn.disabled = true;
                startBtn.textContent = "Démarrage...";

                window.pywebview.api.start_sandbox(result => {
                    if (result.status === 'log') {
                        window.addLog(`[BUILD] ${result.message}`);
                    } else if (result.status === 'success') {
                        window.addLog(`Sandbox démarrée. ${result.message}`);
                        sandboxState.isRunning = true;
                        sandboxState.vncPort = result.vnc_port;
                        updateUI();
                        connectVNC(result.vnc_port);
                    } else {
                        window.addLog(`Erreur au démarrage: ${result.message}`, 'error');
                        startBtn.disabled = false;
                    }
                    startBtn.textContent = "Démarrer Sandbox";
                });
            });

            stopBtn.addEventListener('click', () => {
                window.addLog("Demande d'arrêt de la sandbox...");
                stopBtn.disabled = true;
                disconnectVNC();

                window.pywebview.api.stop_sandbox(result => {
                    if (result.status === 'success') {
                        window.addLog(result.message);
                        sandboxState.isRunning = false;
                    } else {
                        window.addLog(`Erreur à l'arrêt: ${result.message}`, 'error');
                    }
                    updateUI();
                });
            });

            // NOUVEAU : Fonction générique pour exécuter une commande
            async function executeCommand(command) {
                if (!command || !sandboxState.isRunning) return;
                
                window.addLog(`> ${command}`);
                
                // Désactiver temporairement les contrôles
                executeBtn.disabled = true;
                quickCommandBtns.forEach(btn => btn.disabled = true);

                try {
                    const result = await window.pywebview.api.execute_in_sandbox(command);
                    if (result.status === 'success') {
                        commandInput.value = ''; // Vider le champ si la commande vient de là
                    } else {
                        window.addLog(`Erreur d'exécution : ${result.message}`, 'error');
                    }
                } catch (e) {
                    window.addLog(`Erreur de communication : ${e}`, 'error');
                } finally {
                    // Réactiver les contrôles en fonction de l'état de la sandbox
                    updateUI();
                }
            }

            // MODIFIÉ : Listener pour le bouton d'exécution
            executeBtn.addEventListener('click', () => {
                executeCommand(commandInput.value.trim());
            });

            // NOUVEAU : Listeners pour les boutons rapides
            quickCommandBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    executeCommand(btn.dataset.command);
                });
            });
            
            commandInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !executeBtn.disabled) { executeBtn.click(); } });

            // Check initial status on load
            async function checkInitialStatus() {
                window.addLog("Vérification du statut initial de la sandbox...");
                const result = await window.pywebview.api.get_sandbox_status();
                if (result.status === 'running') {
                    window.addLog("Sandbox déjà en cours d'exécution. Reconnexion...");
                    sandboxState.isRunning = true;
                    sandboxState.vncPort = result.vnc_port;
                    connectVNC(result.vnc_port);
                } else {
                    window.addLog("Sandbox arrêtée.");
                    sandboxState.isRunning = false;
                }
                updateUI();
            }

            checkInitialStatus();
        });
    </script>
</body>
</html>