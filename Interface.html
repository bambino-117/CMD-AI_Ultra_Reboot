<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Browser App</title>
    <!-- Utilisation de la police Inter de Google Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap">
    <!-- Utilisation de Tailwind CSS pour un style moderne et r√©actif -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0D1117;
            color: #E2E8F0;
            /* Correction de compatibilit√© */
            text-size-adjust: 100%;
        }

        .scroll-container {
            position: relative;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        /* Style de la barre de d√©filement personnalis√©e */
        .scroll-container::-webkit-scrollbar {
            width: 8px;
        }
        .scroll-container::-webkit-scrollbar-track {
            background: #1E1E1E;
        }
        .scroll-container::-webkit-scrollbar-thumb {
            background-color: #4CAF50;
            border-radius: 9999px;
            border: 2px solid #1E1E1E;
        }
        .scroll-container::-webkit-scrollbar-corner {
            background: transparent;
        }

        /* Classes pour les couleurs de l'application */
        .text-info { color: #00BFFF; }
        .text-error { color: #FF4500; }
        .text-success { color: #32CD32; }
        .text-warning { color: #FFD700; }
        
        /* Styles pour le toggle switch global */
        .toggle-switch input:checked + .slider {
            background-color: #4CAF50;
        }
        .toggle-switch input:not(:checked) + .slider {
            background-color: #6B7280;
        }
        .toggle-switch input:checked + .slider + .slider-dot {
            transform: translateX(20px);
        }
        .toggle-switch input:not(:checked) + .slider + .slider-dot {
            transform: translateX(0px);
        }

        /* Style discret pour le slider Enter = Envoyer */
        .enter-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .enter-toggle .slider {
            width: 20px;
            height: 10px;
            background-color: #6B7280;
            border-radius: 9999px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .enter-toggle .slider:before {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: white;
            border-radius: 50%;
            top: 1px;
            left: 1px;
            transition: transform 0.2s;
        }
        .enter-toggle input:checked + .slider {
            background-color: #4CAF50;
        }
        .enter-toggle input:checked + .slider:before {
            transform: translateX(10px);
        }
    </style>
</head>
<body class="p-4 md:p-8 flex flex-col items-center justify-center min-h-screen">

    <div class="browser-container bg-[#1E1E1E] w-full max-w-6xl h-[calc(100vh-64px)] md:h-[calc(100vh-128px)] rounded-xl shadow-2xl flex flex-col border border-[#2D2D2D] overflow-hidden">

        <!-- Header du navigateur avec barre d'URL et boutons de navigation -->
        <header class="bg-[#2D2D2D] p-3 flex items-center justify-between shadow-lg">
            <div class="flex items-center space-x-2">
                <!-- Boutons de navigation Pr√©c√©dent/Suivant -->
                <button id="back-button" class="w-8 h-8 rounded-full bg-gray-500 hover:bg-gray-600 transition-colors duration-200 flex items-center justify-center disabled:opacity-30 disabled:cursor-not-allowed" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <button id="forward-button" class="w-8 h-8 rounded-full bg-gray-500 hover:bg-gray-600 transition-colors duration-200 flex items-center justify-center disabled:opacity-30 disabled:cursor-not-allowed" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
                <!-- Toggle Entr√©e = Envoyer -->
                <div class="flex items-center gap-2 bg-[#374151] px-3 py-1 rounded-full border border-[#4B5563]">
                    <span class="text-xs text-gray-300">Enter</span>
                    <label class="toggle-switch relative inline-block w-10 h-5">
                        <input type="checkbox" id="global-enter-to-send" checked class="opacity-0 w-0 h-0">
                        <span class="slider absolute cursor-pointer top-0 left-0 right-0 bottom-0 bg-green-500 transition-all duration-300 rounded-full"></span>
                        <span class="slider-dot absolute content-[''] h-4 w-4 left-0.5 bottom-0.5 bg-white transition-all duration-300 rounded-full"></span>
                    </label>
                </div>
            </div>
            <div class="flex-1 mx-4">
                <input type="text" id="url-bar" class="w-full bg-[#1E1E1E] text-white rounded-full px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-success" value="about:home">
            </div>
            <button id="search-button" class="px-4 py-2 bg-success text-black font-medium rounded-full hover:bg-green-600 transition-colors duration-200">Go</button>
        </header>

        <!-- Conteneur des onglets et bouton d'ajout -->
        <div class="flex bg-[#1E1E1E] border-b border-[#2D2D2D]">
            <div id="tabs-container" class="flex flex-1 overflow-x-auto">
                <!-- Les onglets sont ajout√©s ici par JS -->
            </div>
            <button id="add-tab-btn" class="py-2 px-4 text-sm font-medium text-gray-400 hover:bg-[#2D2D2D] transition-colors duration-200 border-l border-[#2D2D2D] flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
            </button>
        </div>

        <!-- Conteneur principal: zone de contenu + barre lat√©rale -->
        <div class="flex-1 flex overflow-hidden">
            
            <!-- Zone de contenu principale (simule une page web) -->
            <main id="main-content" class="flex-1 p-6 scroll-container text-gray-300 relative flex flex-col">
                <!-- Le contenu des pages est ajout√© ici par JS -->
            </main>

            <!-- Barre lat√©rale pour les outils -->
            <aside id="sidebar" class="w-64 bg-[#2D2D2D] p-4 flex flex-col items-center shadow-2xl relative transition-transform duration-300 ease-in-out">
                <h2 class="text-lg font-bold text-white mb-4">Mes Outils</h2>
                <div class="flex flex-col space-y-4 w-full">
                    <!-- Bouton pour l'outil de question -->
                    <button id="ask-button" class="w-full py-3 px-4 bg-[#555] rounded-lg text-white text-sm font-medium hover:bg-[#339933] transition-colors duration-200 flex items-center justify-start space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17.93c-3.6-1.55-6-5.18-6-9.93 0-.74.1-1.46.29-2.15l-1.39-1.39C3.1 9.9 2.15 11.45 2.07 13h2.08c.15 0 .28-.05.41-.14L5.67 11.7l-1.46-1.46-1.47 1.47a.78.78 0 01-.1.14l-.06-.06a.78.78 0 01-.14-.41l1.46-1.46 1.47-1.47 1.46 1.46a.78.78 0 01.14.41l-.06.06a.78.78 0 01-.14.1l-1.46 1.46-1.47-1.47zm.58-13.88c.84-.71 1.8-1.29 2.85-1.74l-1.39-1.39C14.1 4.1 12.55 2.15 11 2.07v2.08c0 .15.05.28.14.41l1.46 1.46 1.47-1.47 1.47 1.47zm1.46 1.46c.84.71 1.54 1.52 2.1 2.45l-1.39 1.39c-1.55 3.6-5.18 6-9.93 6H4.07c.15 0 .28-.05.41-.14l1.46-1.46 1.47 1.47 1.47-1.47a.78.78 0 01-.14.41l-.06.06a.78.78 0 01-.14.1l-1.46 1.46-1.47-1.47 1.47-1.47z"/>
                        </svg>
                        <span>Poser une question</span>
                    </button>
                    <!-- Bouton pour l'outil de planification -->
                    <button id="plan-button" class="w-full py-3 px-4 bg-[#555] rounded-lg text-white text-sm font-medium hover:bg-[#339933] transition-colors duration-200 flex items-center justify-start space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M16 10H8v2h8v-2zm0 4H8v2h8v-2zm2-10h-1V2h-2v2h-8V2H7v2H6c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zM6 20V6h12v14H6z"/>
                        </svg>
                        <span>G√©n√©rer un plan</span>
                    </button>
                    <!-- Bouton pour l'outil de synth√®se vocale -->
                    <button id="speak-button" class="w-full py-3 px-4 bg-[#555] rounded-lg text-white text-sm font-medium hover:bg-[#339933] transition-colors duration-200 flex items-center justify-start space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM7 16V8h2.05l.95-.95V7h-4v2h2V16H7zm9-8h-2v8h2V8zm-1.5-3.5c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5z"/>
                        </svg>
                        <span>Synth√®se vocale</span>
                    </button>
                    <button id="ai-system-button" class="w-full py-3 px-4 bg-[#555] rounded-lg text-white text-sm font-medium hover:bg-[#339933] transition-colors duration-200 flex items-center justify-start space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                        <span>AI System Manager</span>
                    </button>
                </div>
                <button id="toggle-tools-button" class="w-full py-3 px-4 bg-[#555] rounded-lg text-white text-sm font-medium hover:bg-[#339933] transition-colors duration-200 mt-4">
                    Marketplace
                </button>
            </aside>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // √âl√©ments du DOM
            const backButton = document.getElementById('back-button');
            const forwardButton = document.getElementById('forward-button');
            const tabsContainer = document.getElementById('tabs-container');
            const addTabButton = document.getElementById('add-tab-btn');
            const mainContent = document.getElementById('main-content');
            const urlBar = document.getElementById('url-bar');
            const searchButton = document.getElementById('search-button');
            const globalEnterToSend = document.getElementById('global-enter-to-send');
            
            // Syst√®me global Entr√©e = Envoyer
            function setupGlobalEnterToSend() {
                localStorage.setItem('globalEnterToSendEnabled', globalEnterToSend.checked);
                
                // Propager √† toutes les iframes
                document.querySelectorAll('iframe').forEach(iframe => {
                    try {
                        iframe.contentWindow.postMessage({
                            type: 'enterToSendToggle',
                            enabled: globalEnterToSend.checked
                        }, '*');
                    } catch (e) {
                        // Ignorer les erreurs de cross-origin
                    }
                });
            }
            
            // Charger la pr√©f√©rence sauvegard√©e
            const savedGlobalPreference = localStorage.getItem('globalEnterToSendEnabled');
            if (savedGlobalPreference !== null) {
                globalEnterToSend.checked = savedGlobalPreference === 'true';
            }
            
            // √âcouter les changements du toggle global
            globalEnterToSend.addEventListener('change', setupGlobalEnterToSend);
            
            // √âcouter les messages des extensions
            window.addEventListener('message', (event) => {
                if (event.data.type === 'enterToSendToggle') {
                    globalEnterToSend.checked = event.data.enabled;
                    localStorage.setItem('globalEnterToSendEnabled', event.data.enabled);
                    setupGlobalEnterToSend();
                } else if (event.data.type === 'openTab') {
                    const tabId = createTab(event.data.tabName, event.data.tabType);
                    activateTab(tabId, event.data.tabType);
                } else if (event.data.type === 'hotUpdate') {
                    handleHotUpdate(event.data);
                }
            });
            
            // Syst√®me de mise √† jour √† chaud
            function handleHotUpdate(updateData) {
                if (updateData.action === 'reload') {
                    location.reload();
                } else if (updateData.action === 'updateCSS') {
                    const style = document.createElement('style');
                    style.textContent = updateData.css;
                    document.head.appendChild(style);
                } else if (updateData.action === 'executeJS') {
                    eval(updateData.js);
                }
            }
            
            // V√©rification p√©riodique des mises √† jour
            setInterval(async () => {
                try {
                    const response = await fetch('/api/check-updates');
                    if (response.ok) {
                        const updates = await response.json();
                        if (updates.hasUpdate) {
                            handleHotUpdate(updates);
                        }
                    }
                } catch (e) {
                    // Ignorer les erreurs de connexion
                }
            }, 30000); // V√©rifier toutes les 30 secondes
            
            // √âl√©ments pour les outils
            const askButton = document.getElementById('ask-button');
            const planButton = document.getElementById('plan-button');
            const speakButton = document.getElementById('speak-button');
            const sidebar = document.getElementById('sidebar');

            // √âtat de l'application
            let tabCounter = 0;
            let activeTabId = null;
            let tabState = {}; // Renomm√© de toolOutputRefs pour plus de clart√©

            // D√©tection de l'appui long
            let longPressTimer = null;
            const longPressDuration = 7000; // 7 secondes pour l'appui long

            // Mod√®les de pages
            const pages = {
                'home': `
                    <div class="flex flex-col justify-center items-center text-center h-full">
                        <h1 class="text-3xl md:text-5xl font-bold text-white mb-4">Bienvenue sur votre Espace de Travail</h1>
                        <p class="mb-4 text-sm md:text-base max-w-lg">Utilisez les languettes en bas de l'√©cran pour acc√©der aux outils et extensions.</p>
                        <div class="flex space-x-4 mt-6">
                            <div class="bg-[#2D2D2D] p-4 rounded-lg">
                                <h3 class="text-lg font-bold text-white mb-2">üõ†Ô∏è Outils IA</h3>
                                <p class="text-gray-300 text-sm">Questions, Plans, Synth√®se vocale</p>
                            </div>
                            <div class="bg-[#2D2D2D] p-4 rounded-lg">
                                <h3 class="text-lg font-bold text-white mb-2">üîç ZDUK Search</h3>
                                <p class="text-gray-300 text-sm">Moteur de recherche intelligent</p>
                            </div>
                            <div class="bg-[#2D2D2D] p-4 rounded-lg">
                                <h3 class="text-lg font-bold text-white mb-2">üè™ Extensions</h3>
                                <p class="text-gray-300 text-sm">M√©t√©o, Marketplace</p>
                            </div>
                        </div>
                        <div class="mt-6">
                            <input id="home-search" type="text" class="w-96 bg-[#2D2D2D] text-white rounded-full px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-success" placeholder="Rechercher avec ZDUK Search ou entrer une URL...">
                            <button id="home-search-btn" class="ml-2 px-6 py-3 bg-success text-black font-medium rounded-full hover:bg-green-600 transition-colors duration-200">Rechercher</button>
                        </div>
                        <div class="mt-4 text-center">
                            <p class="text-gray-400 text-sm">Propuls√© par <span class="text-green-400 font-semibold">ZDUK Search</span> - Notre moteur de recherche intelligent</p>
                        </div>
                    </div>
                `,
                'web': (tabId) => `
                    <iframe id="iframe-${tabId}" class="w-full h-full border-0" sandbox="allow-forms allow-scripts allow-same-origin allow-popups allow-presentation"></iframe>
                `
            };

            function toggleTools(tabId) {
                const toolsContainer = document.getElementById(`tools-container-${tabId}`);
                const iframe = document.getElementById(`iframe-${tabId}`);

                if (toolsContainer.classList.contains('hidden')) {
                    toolsContainer.classList.remove('hidden');
                    iframe.classList.add('hidden');
                } else {
                    toolsContainer.classList.add('hidden');
                    iframe.classList.remove('hidden');
                }
            }

            // --- Fonctions d'assistance pour l'API Gemini ---
            async function geminiApiCall(payload, modelName) {
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
                
                let attempt = 0;
                const maxAttempts = 5;

                while (attempt < maxAttempts) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            return await response.json();
                        } else if (response.status === 429) {
                            const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                            await new Promise(res => setTimeout(res, delay));
                            attempt++;
                        } else {
                            throw new Error(`API call failed with status: ${response.status}`);
                        }
                    } catch (error) {
                        if (attempt === maxAttempts - 1) {
                            console.error("Gemini API call failed after multiple retries:", error);
                            return null;
                        }
                        attempt++;
                    }
                }
            }

            function base64ToArrayBuffer(base64) {
                const binaryString = atob(base64);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return bytes.buffer;
            }

            function pcmToWav(pcm16, sampleRate) {
                const numChannels = 1;
                const sampleBits = 16;
                const byteRate = numChannels * sampleRate * (sampleBits / 8);
                const blockAlign = numChannels * (sampleBits / 8);

                const wavHeader = new ArrayBuffer(44);
                const view = new DataView(wavHeader);
                view.setUint32(0, 0x52494646, false);
                view.setUint32(4, 36 + pcm16.length * 2, true);
                view.setUint32(8, 0x57415645, false);
                view.setUint32(12, 0x666d7420, false);
                view.setUint32(16, 16, true);
                view.setUint16(20, 1, true);
                view.setUint16(22, numChannels, true);
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, byteRate, true);
                view.setUint16(32, blockAlign, true);
                view.setUint16(34, sampleBits, true);
                view.setUint32(36, 0x64617461, false);
                view.setUint32(40, pcm16.length * 2, true);

                const output = new Blob([wavHeader, pcm16], { type: 'audio/wav' });
                return output;
            }

            // --- Fonctions des outils (modifi√©es pour les onglets) ---
            const showLoading = () => {
                const spinner = document.getElementById(`loading-spinner-${activeTabId}`);
                if (spinner) spinner.classList.remove('hidden');
                const output = document.getElementById(`tool-output-${activeTabId}`);
                if (output) output.innerHTML = '';
            };

            const hideLoading = () => {
                const spinner = document.getElementById(`loading-spinner-${activeTabId}`);
                if (spinner) spinner.classList.add('hidden');
            };

            const appendText = (text, tag) => {
                const output = document.getElementById(`tool-output-${activeTabId}`);
                const resultsArea = document.getElementById(`results-area-${activeTabId}`);
                if (!output || !resultsArea) return;
                
                const line = document.createElement('div');
                line.textContent = text;
                line.classList.add('whitespace-pre-wrap');
                if (tag) {
                    line.classList.add(`text-${tag}`);
                }
                output.appendChild(line);
                resultsArea.scrollTop = resultsArea.scrollHeight;
                if (tabState[activeTabId]) {
                    tabState[activeTabId].lastOutputText = text;
                }
            };

            const appendJson = (json) => {
                const output = document.getElementById(`tool-output-${activeTabId}`);
                const resultsArea = document.getElementById(`results-area-${activeTabId}`);
                if (!output || !resultsArea) return;

                output.innerHTML = '';
                json.forEach(item => {
                    const titleEl = document.createElement('h3');
                    titleEl.classList.add('text-lg', 'font-bold', 'text-warning', 'mt-4');
                    titleEl.textContent = item.title;
                    output.appendChild(titleEl);

                    const stepsList = document.createElement('ul');
                    stepsList.classList.add('list-disc', 'pl-5', 'text-info');
                    item.steps.forEach(step => {
                        const stepEl = document.createElement('li');
                        stepEl.textContent = step;
                        stepsList.appendChild(stepEl);
                    });
                    output.appendChild(stepsList);
                });
                resultsArea.scrollTop = resultsArea.scrollHeight;
                if (toolOutputRefs[activeTabId]) {
                    toolOutputRefs[activeTabId].lastOutputText = JSON.stringify(json, null, 2);
                }
            };
            
            async function handleAskCommand(prompt) {
                const tabId = createTab('Conversation IA', 'ai-chat');
                activateTab(tabId, 'ai-chat');

                const chatContainer = document.getElementById(`page-${tabId}`);
                chatContainer.innerHTML = `
                    <div class="flex flex-col h-full">
                        <div id="chat-history-${tabId}" class="flex-1 overflow-y-auto p-4 bg-[#1E1E1E] text-white rounded-lg">
                            <!-- Historique des messages -->
                        </div>
                        <div class="flex items-center p-4 bg-[#2D2D2D]">
                            <input id="chat-input-${tabId}" type="text" class="flex-1 bg-[#1E1E1E] text-white rounded-full px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-success" placeholder="Posez votre question...">
                            <button id="send-chat-${tabId}" class="ml-4 px-4 py-2 bg-success text-black font-medium rounded-full hover:bg-green-600 transition-colors duration-200">Envoyer</button>
                        </div>
                    </div>
                `;

                const chatInput = document.getElementById(`chat-input-${tabId}`);
                const sendButton = document.getElementById(`send-chat-${tabId}`);
                const chatHistory = document.getElementById(`chat-history-${tabId}`);

                const appendMessage = (message, isUser = false) => {
                    const messageDiv = document.createElement('div');
                    messageDiv.textContent = message;
                    messageDiv.classList.add('p-2', 'mb-2', 'rounded-lg', 'text-sm', 'whitespace-pre-wrap');
                    messageDiv.classList.add(isUser ? 'bg-success text-black self-end' : 'bg-gray-700 text-white self-start');
                    chatHistory.appendChild(messageDiv);
                    chatHistory.scrollTop = chatHistory.scrollHeight;
                };

                const sendMessage = async () => {
                    const userMessage = chatInput.value.trim();
                    if (!userMessage) return;

                    appendMessage(userMessage, true);
                    chatInput.value = '';

                    // Simuler une r√©ponse de l'IA (remplacer par un appel API r√©el si n√©cessaire)
                    appendMessage('R√©ponse de l\'IA en cours...', false);
                    setTimeout(() => {
                        appendMessage(`Voici une r√©ponse g√©n√©r√©e pour : "${userMessage}"`, false);
                    }, 1000);
                };

                sendButton.addEventListener('click', sendMessage);
                chatInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && globalEnterToSend.checked) sendMessage();
                });
            }

            // Fonctions des outils
            async function handlePlanCommand(prompt) {
                const tabId = createTab('G√©n√©rateur de Plan', 'plan');
                activateTab(tabId, 'plan');

                const planContainer = document.getElementById(`page-${tabId}`);
                planContainer.innerHTML = `
                    <div class="flex flex-col h-full p-6">
                        <h1 class="text-3xl font-bold text-white mb-6">üìã G√©n√©rateur de Plan</h1>
                        <div class="flex-1 bg-[#1E1E1E] rounded-lg p-4">
                            <div class="mb-4">
                                <input id="plan-input-${tabId}" type="text" class="w-full bg-[#2D2D2D] text-white rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-success" placeholder="D√©crivez ce que vous voulez planifier...">
                                <button id="generate-plan-${tabId}" class="mt-2 px-4 py-2 bg-success text-black font-medium rounded hover:bg-green-600 transition-colors duration-200">G√©n√©rer le plan</button>
                            </div>
                            <div id="plan-output-${tabId}" class="text-white">
                                <p class="text-gray-400">Entrez une description pour g√©n√©rer un plan d√©taill√©.</p>
                            </div>
                        </div>
                    </div>
                `;

                const planInput = document.getElementById(`plan-input-${tabId}`);
                const generateButton = document.getElementById(`generate-plan-${tabId}`);
                const planOutput = document.getElementById(`plan-output-${tabId}`);

                const generatePlan = () => {
                    const userInput = planInput.value.trim();
                    if (!userInput) return;

                    planOutput.innerHTML = '<p class="text-info">G√©n√©ration du plan en cours...</p>';
                    
                    // Simulation d'un plan g√©n√©r√©
                    setTimeout(() => {
                        planOutput.innerHTML = `
                            <h3 class="text-lg font-bold text-warning mb-2">Plan pour: ${userInput}</h3>
                            <ul class="list-disc pl-5 text-info space-y-1">
                                <li>√âtape 1: Analyse des besoins</li>
                                <li>√âtape 2: Recherche et pr√©paration</li>
                                <li>√âtape 3: Mise en ≈ìuvre</li>
                                <li>√âtape 4: √âvaluation et ajustements</li>
                            </ul>
                        `;
                    }, 1500);
                };

                generateButton.addEventListener('click', generatePlan);
                planInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && globalEnterToSend.checked) generatePlan();
                });
            }

            function handleSpeakCommand() {
                const tabId = createTab('Synth√®se Vocale', 'speech');
                activateTab(tabId, 'speech');

                const speechContainer = document.getElementById(`page-${tabId}`);
                speechContainer.innerHTML = `
                    <div class="flex flex-col h-full p-6">
                        <h1 class="text-3xl font-bold text-white mb-6">üîä Synth√®se Vocale</h1>
                        <div class="flex-1 bg-[#1E1E1E] rounded-lg p-4">
                            <div class="mb-4">
                                <textarea id="speech-input-${tabId}" class="w-full h-32 bg-[#2D2D2D] text-white rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-success resize-none" placeholder="Entrez le texte √† lire..."></textarea>
                                <div class="flex space-x-2 mt-2">
                                    <button id="speak-text-${tabId}" class="px-4 py-2 bg-success text-black font-medium rounded hover:bg-green-600 transition-colors duration-200">üîä Lire</button>
                                    <button id="stop-speech-${tabId}" class="px-4 py-2 bg-red-500 text-white font-medium rounded hover:bg-red-600 transition-colors duration-200">‚èπÔ∏è Arr√™ter</button>
                                </div>
                            </div>
                            <div id="speech-status-${tabId}" class="text-gray-400">
                                <p>Pr√™t √† lire du texte.</p>
                            </div>
                        </div>
                    </div>
                `;

                const speechInput = document.getElementById(`speech-input-${tabId}`);
                const speakButton = document.getElementById(`speak-text-${tabId}`);
                const stopButton = document.getElementById(`stop-speech-${tabId}`);
                const speechStatus = document.getElementById(`speech-status-${tabId}`);

                let currentUtterance = null;

                const speakText = () => {
                    const text = speechInput.value.trim();
                    if (!text) return;

                    if ('speechSynthesis' in window) {
                        // Arr√™ter toute lecture en cours
                        speechSynthesis.cancel();
                        
                        currentUtterance = new SpeechSynthesisUtterance(text);
                        currentUtterance.lang = 'fr-FR';
                        
                        currentUtterance.onstart = () => {
                            speechStatus.innerHTML = '<p class="text-success">Lecture en cours...</p>';
                        };
                        
                        currentUtterance.onend = () => {
                            speechStatus.innerHTML = '<p class="text-gray-400">Lecture termin√©e.</p>';
                        };
                        
                        currentUtterance.onerror = () => {
                            speechStatus.innerHTML = '<p class="text-error">Erreur lors de la lecture.</p>';
                        };
                        
                        speechSynthesis.speak(currentUtterance);
                    } else {
                        speechStatus.innerHTML = '<p class="text-error">Synth√®se vocale non support√©e par ce navigateur.</p>';
                    }
                };

                const stopSpeech = () => {
                    if ('speechSynthesis' in window) {
                        speechSynthesis.cancel();
                        speechStatus.innerHTML = '<p class="text-warning">Lecture arr√™t√©e.</p>';
                    }
                };

                speakButton.addEventListener('click', speakText);
                stopButton.addEventListener('click', stopSpeech);
            }

            // Modification du bouton "Poser une question" pour ouvrir un onglet IA
            document.getElementById('ask-button').addEventListener('click', () => {
                handleAskCommand('');
            });

            // Endpoint pour d√©marrer le System Monitor
            async function startSystemMonitor() {
                try {
                    const response = await fetch('/start-system-monitor', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    return response.ok;
                } catch (error) {
                    console.error('Erreur lors du d√©marrage du System Monitor:', error);
                    return false;
                }
            }



            // D√©placement de l'initialisation de toolOutputRefs en haut du script pour √©viter les erreurs d'acc√®s avant initialisation
            let toolOutputRefs = {};

            // --- Logique de gestion des onglets ---
            function createTab(name, type) {
                const tabId = type + '-' + tabCounter++;
                
                const tabButton = document.createElement('button');
                tabButton.id = `tab-${tabId}`;
                tabButton.classList.add('py-2', 'px-6', 'text-sm', 'font-medium', 'border-r', 'border-[#2D2D2D]', 'text-gray-400', 'hover:bg-[#2D2D2D]', 'transition-colors', 'duration-200', 'flex', 'items-center', 'cursor-pointer');
                tabButton.innerHTML = `<span class="flex-1">${name}</span>`;

                if (type !== 'home') {
                    const closeButton = document.createElement('button');
                    closeButton.classList.add('ml-2', 'h-4', 'w-4', 'text-gray-400', 'hover:text-white', 'hover:bg-[#2D2D2D]', 'rounded');
                    closeButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>`;
                    closeButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        closeTab(tabId);
                    });
                    tabButton.appendChild(closeButton);
                }
                
                tabButton.addEventListener('click', () => activateTab(tabId, type));
                tabsContainer.appendChild(tabButton);
                
                const page = document.createElement('div');
                page.id = `page-${tabId}`;
                page.classList.add('page-content', 'hidden', 'flex-1', 'flex', 'flex-col');
                mainContent.appendChild(page);

                if (type === 'home') {
                    page.innerHTML = pages.home;
                    toolOutputRefs[tabId] = {
                        history: [{ url: `about:home`, content: '' }],
                        historyIndex: 0
                    };
                } else if (type === 'weather') {
                    page.innerHTML = `<iframe id="iframe-${tabId}" class="w-full h-full border-0" src="./extensions/M√©t√©o.html" sandbox="allow-forms allow-scripts allow-same-origin allow-popups allow-presentation allow-downloads"></iframe>`;
                    toolOutputRefs[tabId] = {
                        history: [{ url: `./extensions/M√©t√©o.html`, content: '' }],
                        historyIndex: 0
                    };
                } else if (type === 'usb-manager') {
                    page.innerHTML = `<iframe id="iframe-${tabId}" class="w-full h-full border-0" src="./extensions/Usb_manager.html" sandbox="allow-forms allow-scripts allow-same-origin allow-popups allow-presentation allow-downloads"></iframe>`;
                    toolOutputRefs[tabId] = {
                        history: [{ url: `./extensions/Usb_manager.html`, content: '' }],
                        historyIndex: 0
                    };
                } else if (type === 'system-monitor') {
                    page.innerHTML = `
                        <div class="flex flex-col h-full p-6">
                            <div class="bg-[#2D2D2D] p-6 rounded-lg mb-4">
                                <h2 class="text-xl font-bold text-white mb-4">üìä System Monitor</h2>
                                <p class="text-gray-300 mb-4">Le System Monitor n√©cessite le d√©marrage d'un serveur local pour fonctionner.</p>
                                <div class="flex gap-4">
                                    <button id="start-monitor-${tabId}" class="px-6 py-3 bg-green-600 text-white font-medium rounded hover:bg-green-700 transition-colors duration-200">
                                        üöÄ D√©marrer le serveur
                                    </button>
                                    <button id="open-monitor-${tabId}" class="px-6 py-3 bg-blue-600 text-white font-medium rounded hover:bg-blue-700 transition-colors duration-200" disabled>
                                        üìä Ouvrir l'interface
                                    </button>
                                </div>
                                <div id="monitor-status-${tabId}" class="mt-4 text-sm text-gray-400">
                                    Serveur arr√™t√© - Cliquez sur "D√©marrer le serveur" pour commencer
                                </div>
                            </div>
                            <div id="monitor-iframe-container-${tabId}" class="flex-1 hidden">
                                <iframe id="iframe-${tabId}" class="w-full h-full border-0" src="" sandbox="allow-forms allow-scripts allow-popups allow-presentation allow-downloads"></iframe>
                            </div>
                        </div>
                    `;
                    
                    const startBtn = document.getElementById(`start-monitor-${tabId}`);
                    const openBtn = document.getElementById(`open-monitor-${tabId}`);
                    const status = document.getElementById(`monitor-status-${tabId}`);
                    const iframeContainer = document.getElementById(`monitor-iframe-container-${tabId}`);
                    const iframe = document.getElementById(`iframe-${tabId}`);
                    
                    startBtn.addEventListener('click', async () => {
                        status.innerHTML = 'üîÑ D√©marrage du serveur en cours...';
                        startBtn.disabled = true;
                        
                        try {
                            const response = await fetch('http://127.0.0.1:5001/api/status');
                            if (response.ok) {
                                status.innerHTML = '‚úÖ Serveur d√©j√† en cours d\'ex√©cution';
                                openBtn.disabled = false;
                            } else {
                                throw new Error('Serveur non accessible');
                            }
                        } catch (error) {
                            // Tenter de d√©marrer le serveur
                            try {
                                await fetch('/start-system-monitor', { method: 'POST' });
                                setTimeout(async () => {
                                    try {
                                        const testResponse = await fetch('http://127.0.0.1:5001/api/status');
                                        if (testResponse.ok) {
                                            status.innerHTML = '‚úÖ Serveur d√©marr√© avec succ√®s';
                                            openBtn.disabled = false;
                                        } else {
                                            throw new Error('√âchec du d√©marrage');
                                        }
                                    } catch {
                                        status.innerHTML = '‚ùå √âchec du d√©marrage automatique. Veuillez ex√©cuter manuellement start_system_monitor.bat';
                                        startBtn.disabled = false;
                                    }
                                }, 3000);
                            } catch {
                                status.innerHTML = '‚ùå Impossible de d√©marrer automatiquement. Veuillez ex√©cuter manuellement start_system_monitor.bat';
                                startBtn.disabled = false;
                            }
                        }
                    });
                    
                    openBtn.addEventListener('click', () => {
                        iframe.src = './extensions/System_monitor/interface_simple.html';
                        iframeContainer.classList.remove('hidden');
                        status.innerHTML = '‚úÖ Interface System Monitor charg√©e';
                    });
                    
                    toolOutputRefs[tabId] = {
                        history: [{ url: `about:system-monitor`, content: '' }],
                        historyIndex: 0
                    };
                } else if (type === 'network-toolkit') {
                    page.innerHTML = `<iframe id="iframe-${tabId}" class="w-full h-full border-0" src="./extensions/Network Tool Kit.html" sandbox="allow-forms allow-scripts allow-same-origin allow-popups allow-presentation allow-downloads"></iframe>`;
                    toolOutputRefs[tabId] = {
                        history: [{ url: `./extensions/Network Tool Kit.html`, content: '' }],
                        historyIndex: 0
                    };
                } else if (type === 'ai-system') {
                    page.innerHTML = `<iframe id="iframe-${tabId}" class="w-full h-full border-0" src="./extensions/AI_System_Manager.html" sandbox="allow-forms allow-scripts allow-popups allow-presentation allow-downloads"></iframe>`;
                    toolOutputRefs[tabId] = {
                        history: [{ url: `./extensions/AI_System_Manager.html`, content: '' }],
                        historyIndex: 0
                    };
                } else if (type === 'marketplace') {
                    page.innerHTML = `
                        <div class="flex flex-col h-full p-6">
                            <h1 class="text-3xl font-bold text-white mb-6">üè™ Marketplace des Extensions</h1>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 flex-1">
                                <div class="bg-[#2D2D2D] p-4 rounded-lg">
                                    <h3 class="text-lg font-bold text-white mb-2">üõ†Ô∏è OSINT Tools</h3>
                                    <p class="text-gray-300 mb-4">Suite d'outils pour la recherche en sources ouvertes</p>
                                    <button class="px-4 py-2 bg-success text-black font-medium rounded hover:bg-green-600 transition-colors duration-200">Installer</button>
                                </div>
                                <div class="bg-[#2D2D2D] p-4 rounded-lg">
                                    <h3 class="text-lg font-bold text-white mb-2">üìù Code Formatter</h3>
                                    <p class="text-gray-300 mb-4">Outil pour formater automatiquement votre code</p>
                                    <button class="px-4 py-2 bg-success text-black font-medium rounded hover:bg-green-600 transition-colors duration-200">Installer</button>
                                </div>
                            </div>
                        </div>
                    `;
                    toolOutputRefs[tabId] = {
                        history: [{ url: `about:marketplace`, content: '' }],
                        historyIndex: 0
                    };
                } else if (type === 'plan') {
                    // Le contenu sera ajout√© par handlePlanCommand
                    toolOutputRefs[tabId] = {
                        history: [{ url: `about:plan`, content: '' }],
                        historyIndex: 0
                    };
                } else if (type === 'speech') {
                    // Le contenu sera ajout√© par handleSpeakCommand
                    toolOutputRefs[tabId] = {
                        history: [{ url: `about:speech`, content: '' }],
                        historyIndex: 0
                    };
                } else if (type === 'ai-chat') {
                    // Le contenu sera ajout√© par handleAskCommand
                    toolOutputRefs[tabId] = {
                        history: [{ url: `about:ai-chat`, content: '' }],
                        historyIndex: 0
                    };
                } else if (type === 'security-toolkit') {
                    page.innerHTML = `<iframe id="iframe-${tabId}" class="w-full h-full border-0" src="./extensions/Security_Toolkit/security_toolkit_interface.html" sandbox="allow-forms allow-scripts allow-same-origin allow-popups allow-presentation allow-downloads"></iframe>`;
                    toolOutputRefs[tabId] = {
                        history: [{ url: `./extensions/Security_Toolkit/security_toolkit_interface.html`, content: '' }],
                        historyIndex: 0
                    };
                } else if (type === 'osint-research') {
                    page.innerHTML = `<iframe id="iframe-${tabId}" class="w-full h-full border-0" src="./extensions/OSINT/osint_research_interface.html" sandbox="allow-forms allow-scripts allow-same-origin allow-popups allow-presentation allow-downloads"></iframe>`;
                    toolOutputRefs[tabId] = {
                        history: [{ url: `./extensions/OSINT/osint_research_interface.html`, content: '' }],
                        historyIndex: 0
                    };
                } else if (type === 'osint-container') {
                    page.innerHTML = `<iframe id="iframe-${tabId}" class="w-full h-full border-0" src="./extensions/OSINT/osint_container.html" sandbox="allow-forms allow-scripts allow-same-origin allow-popups allow-presentation allow-downloads"></iframe>`;
                    toolOutputRefs[tabId] = {
                        history: [{ url: `./extensions/OSINT/osint_container.html`, content: '' }],
                        historyIndex: 0
                    };
                } else if (type === 'data-analyzer') {
                    page.innerHTML = `<iframe id="iframe-${tabId}" class="w-full h-full border-0" src="./extensions/OSINT/data_analyzer_interface.html" sandbox="allow-forms allow-scripts allow-same-origin allow-popups allow-presentation allow-downloads"></iframe>`;
                    toolOutputRefs[tabId] = {
                        history: [{ url: `./extensions/OSINT/data_analyzer_interface.html`, content: '' }],
                        historyIndex: 0
                    };
                } else if (type === 'incogni-me') {
                    page.innerHTML = `<iframe id="iframe-${tabId}" class="w-full h-full border-0" src="./extensions/OSINT/incogni_me_interface.html" sandbox="allow-forms allow-scripts allow-same-origin allow-popups allow-presentation allow-downloads"></iframe>`;
                    toolOutputRefs[tabId] = {
                        history: [{ url: `./extensions/OSINT/incogni_me_interface.html`, content: '' }],
                        historyIndex: 0
                    };
                } else if (type === 'settings-tab') {
                    page.innerHTML = `
                        <div class="flex flex-col h-full p-6">
                            <h1 class="text-3xl font-bold text-white mb-6">‚öôÔ∏è Param√®tres de l'Application</h1>
                            <div class="flex-1 bg-[#1E1E1E] rounded-lg p-6 space-y-6">
                                <!-- Section Apparence -->
                                <div class="bg-[#2D2D2D] p-4 rounded-lg">
                                    <h3 class="text-lg font-bold text-white mb-4">üé® Apparence</h3>
                                    <div class="flex items-center justify-between">
                                        <label for="theme-select-tab" class="text-gray-300">Th√®me de l'interface</label>
                                        <select id="theme-select-tab" class="bg-[#1E1E1E] text-white rounded px-3 py-2" disabled>
                                            <option value="dark">Sombre (D√©faut)</option>
                                            <option value="light">Clair (Bient√¥t)</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Section Profil Utilisateur -->
                                <div class="bg-[#2D2D2D] p-4 rounded-lg">
                                    <h3 class="text-lg font-bold text-white mb-4">üë§ Profil Utilisateur</h3>
                                    <div class="flex items-center space-x-3">
                                        <input type="text" id="pseudo-input-tab" placeholder="Votre pseudo" class="bg-[#1E1E1E] text-white rounded px-3 py-2 flex-1 focus:outline-none focus:ring-2 focus:ring-success">
                                        <button id="pseudo-validate-tab" class="px-4 py-2 bg-success text-black font-medium rounded hover:bg-green-600 transition-colors duration-200">Valider</button>
                                    </div>
                                </div>
                                
                                <!-- Section T√©l√©chargements -->
                                <div class="bg-[#2D2D2D] p-4 rounded-lg">
                                    <h3 class="text-lg font-bold text-white mb-4">üì• T√©l√©chargements</h3>
                                    <div class="space-y-3">
                                        <div class="flex items-center justify-between">
                                            <label for="download-location-tab" class="text-gray-300">Emplacement</label>
                                            <div class="flex items-center">
                                                <input type="text" id="download-location-tab" value="C:\\Users\\Utilisateur\\T√©l√©chargements" class="bg-[#1E1E1E] text-white rounded-l px-3 py-2 w-64" readonly>
                                                <button class="px-3 py-2 bg-gray-600 text-white rounded-r hover:bg-gray-700" onclick="alert('Fonctionnalit√© non impl√©ment√©e.')">Modifier</button>
                                            </div>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <label for="always-ask-download-tab" class="text-gray-300">Toujours demander o√π enregistrer</label>
                                            <label class="toggle-switch relative inline-block w-10 h-5">
                                                <input type="checkbox" id="always-ask-download-tab" class="opacity-0 w-0 h-0">
                                                <span class="slider absolute cursor-pointer top-0 left-0 right-0 bottom-0 bg-gray-500 transition-all duration-300 rounded-full"></span>
                                                <span class="slider-dot absolute content-[''] h-4 w-4 left-0.5 bottom-0.5 bg-white transition-all duration-300 rounded-full"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Section Maintenance -->
                                <div class="bg-[#2D2D2D] p-4 rounded-lg">
                                    <h3 class="text-lg font-bold text-white mb-4">üîß Maintenance</h3>
                                    <div class="space-y-3">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <span class="text-gray-300">Vider le cache de l'application</span>
                                                <p class="text-sm text-gray-400">Supprime tous les onglets, historique et param√®tres</p>
                                            </div>
                                            <button id="clear-cache-button-tab" class="px-4 py-2 bg-orange-500 text-black font-medium rounded hover:bg-orange-600 transition-colors duration-200">Vider le cache</button>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <span class="text-gray-300">V√©rifier les mises √† jour</span>
                                                <p class="text-sm text-gray-400">Recherche et applique les mises √† jour disponibles</p>
                                            </div>
                                            <button id="check-updates-button-tab" class="px-4 py-2 bg-blue-500 text-white font-medium rounded hover:bg-blue-600 transition-colors duration-200">V√©rifier</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Initialiser les √©v√©nements pour l'onglet param√®tres
                    setTimeout(() => {
                        // Gestion du pseudo
                        const pseudoInputTab = document.getElementById('pseudo-input-tab');
                        const pseudoValidateTab = document.getElementById('pseudo-validate-tab');
                        
                        const savePseudoTab = () => {
                            const pseudo = pseudoInputTab.value.trim();
                            if (pseudo) {
                                localStorage.setItem('userPseudo', pseudo);
                                alert(`Pseudo d√©fini: ${pseudo}`);
                            }
                        };
                        
                        const loadPseudoTab = () => {
                            const savedPseudo = localStorage.getItem('userPseudo');
                            if (savedPseudo) pseudoInputTab.value = savedPseudo;
                        };
                        
                        loadPseudoTab();
                        pseudoValidateTab.addEventListener('click', savePseudoTab);
                        pseudoInputTab.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter') savePseudoTab();
                        });
                        
                        // Gestion du cache
                        const clearCacheButtonTab = document.getElementById('clear-cache-button-tab');
                        clearCacheButtonTab.addEventListener('click', () => {
                            if (confirm("√ätes-vous s√ªr de vouloir vider le cache ?\nCela r√©initialisera toutes les donn√©es de l'application (onglets, historique, param√®tres) et rechargera la page.")) {
                                localStorage.clear();
                                alert("Le cache a √©t√© vid√©. L'application va maintenant red√©marrer.");
                                location.reload();
                            }
                        });
                        
                        // Gestion des t√©l√©chargements
                        const alwaysAskDownloadToggleTab = document.getElementById('always-ask-download-tab');
                        const saveDownloadSettingsTab = () => localStorage.setItem('alwaysAskDownload', alwaysAskDownloadToggleTab.checked);
                        const loadDownloadSettingsTab = () => {
                            const savedValue = localStorage.getItem('alwaysAskDownload');
                            alwaysAskDownloadToggleTab.checked = savedValue === 'true';
                        };
                        loadDownloadSettingsTab();
                        alwaysAskDownloadToggleTab.addEventListener('change', saveDownloadSettingsTab);
                        
                        // Gestion des mises √† jour
                        const checkUpdatesButtonTab = document.getElementById('check-updates-button-tab');
                        checkUpdatesButtonTab.addEventListener('click', async () => {
                            checkUpdatesButtonTab.textContent = 'V√©rification...';
                            checkUpdatesButtonTab.disabled = true;
                            try {
                                const response = await fetch('/api/check-updates');
                                if (response.ok) {
                                    const updates = await response.json();
                                    if (updates.hasUpdate) {
                                        handleHotUpdate(updates);
                                        alert('Mise √† jour appliqu√©e avec succ√®s !');
                                    } else {
                                        alert('Aucune mise √† jour disponible.');
                                    }
                                } else {
                                    alert('Impossible de v√©rifier les mises √† jour.');
                                }
                            } catch (e) {
                                alert('Erreur de connexion au serveur de mise √† jour.');
                            }
                            checkUpdatesButtonTab.textContent = 'V√©rifier';
                            checkUpdatesButtonTab.disabled = false;
                        });
                    }, 100);
                    
                    toolOutputRefs[tabId] = {
                        history: [{ url: `about:settings`, content: '' }],
                        historyIndex: 0
                    };
                } else if (type === 'web') {
                    page.innerHTML = pages.web(tabId);
                    toolOutputRefs[tabId] = {
                        history: [{ url: '', content: '' }],
                        historyIndex: 0
                    };
                }

                return tabId;
            }

            function closeTab(tabId) {
                const tabButton = document.getElementById(`tab-${tabId}`);
                const page = document.getElementById(`page-${tabId}`);
                
                if (tabButton && page) {
                    const wasActive = tabButton.classList.contains('bg-[#2D2D2D]');
                    
                    tabsContainer.removeChild(tabButton);
                    mainContent.removeChild(page);
                    delete toolOutputRefs[tabId];

                    if (wasActive) {
                        const remainingTabs = Array.from(tabsContainer.children);
                        if (remainingTabs.length > 0) {
                            remainingTabs[remainingTabs.length - 1].click();
                        } else {
                            activeTabId = null;
                            urlBar.value = "about:blank";
                            updateHistoryButtons();
                        }
                    }
                }
            }

            function activateTab(tabId, type) {
                // D√©sactiver tous les onglets
                document.querySelectorAll('#tabs-container button').forEach(tab => {
                    tab.classList.remove('bg-[#2D2D2D]', 'text-white');
                    tab.classList.add('text-gray-400', 'hover:bg-[#2D2D2D]');
                });

                // Cacher toutes les pages
                document.querySelectorAll('.page-content').forEach(page => {
                    page.classList.add('hidden');
                });
                
                // Activer l'onglet s√©lectionn√©
                const selectedTab = document.getElementById(`tab-${tabId}`);
                const selectedPage = document.getElementById(`page-${tabId}`);
                if (selectedTab && selectedPage) {
                    selectedTab.classList.add('bg-[#2D2D2D]', 'text-white');
                    selectedTab.classList.remove('text-gray-400', 'hover:bg-[#2D2D2D]');
                    selectedPage.classList.remove('hidden');
                    urlBar.value = toolOutputRefs[tabId].history[toolOutputRefs[tabId].historyIndex].url;
                    activeTabId = tabId;

                    sidebar.classList.add('hidden');
                    updateHistoryButtons();
                }
            }

            function updateHistoryButtons() {
                if (activeTabId && toolOutputRefs[activeTabId]) {
                    const history = toolOutputRefs[activeTabId].history;
                    const index = toolOutputRefs[activeTabId].historyIndex;
                    backButton.disabled = index <= 0;
                    forwardButton.disabled = index >= history.length - 1;
                } else {
                    backButton.disabled = true;
                    forwardButton.disabled = true;
                }
            }

            function goBack() {
                const currentTab = toolOutputRefs[activeTabId];
                if (currentTab && currentTab.historyIndex > 0) {
                    currentTab.historyIndex--;
                    const previousPage = currentTab.history[currentTab.historyIndex];
                    urlBar.value = previousPage.url;
                    
                    if (previousPage.url === 'about:home') {
                        document.getElementById(`page-${activeTabId}`).innerHTML = pages.home;
                        // R√©attacher les √©v√©nements de recherche
                        setTimeout(() => {
                            const homeSearch = document.getElementById('home-search');
                            const homeSearchBtn = document.getElementById('home-search-btn');
                            if (homeSearch && homeSearchBtn) {
                                const performHomeSearch = () => {
                                    const input = homeSearch.value.trim();
                                    if (input) navigateToUrl(input);
                                };
                                homeSearchBtn.addEventListener('click', performHomeSearch);
                                homeSearch.addEventListener('keydown', (e) => {
                                    if (e.key === 'Enter') performHomeSearch();
                                });
                            }
                        }, 100);
                    } else if (previousPage.url && !previousPage.url.startsWith('about:')) {
                        const iframe = document.getElementById(`iframe-${activeTabId}`);
                        if (iframe) iframe.src = previousPage.url;
                    }
                    updateHistoryButtons();
                }
            }
            
            function goForward() {
                const currentTab = toolOutputRefs[activeTabId];
                if (currentTab && currentTab.historyIndex < currentTab.history.length - 1) {
                    currentTab.historyIndex++;
                    const nextPage = currentTab.history[currentTab.historyIndex];
                    urlBar.value = nextPage.url;

                    if (nextPage.url === 'about:home') {
                        document.getElementById(`page-${activeTabId}`).innerHTML = pages.home;
                        // R√©attacher les √©v√©nements de recherche
                        setTimeout(() => {
                            const homeSearch = document.getElementById('home-search');
                            const homeSearchBtn = document.getElementById('home-search-btn');
                            if (homeSearch && homeSearchBtn) {
                                const performHomeSearch = () => {
                                    const input = homeSearch.value.trim();
                                    if (input) navigateToUrl(input);
                                };
                                homeSearchBtn.addEventListener('click', performHomeSearch);
                                homeSearch.addEventListener('keydown', (e) => {
                                    if (e.key === 'Enter') performHomeSearch();
                                });
                            }
                        }, 100);
                    } else if (nextPage.url && !nextPage.url.startsWith('about:')) {
                        const iframe = document.getElementById(`iframe-${activeTabId}`);
                        if (iframe) iframe.src = nextPage.url;
                    }
                    updateHistoryButtons();
                }
            }



            // Fonction pour d√©tecter si c'est une URL ou une recherche
            function isUrl(input) {
                try {
                    new URL(input);
                    return true;
                } catch {
                    return /^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/.test(input) || input.startsWith('localhost');
                }
            }

            // Fonction pour naviguer vers une URL ou effectuer une recherche
            function navigateToUrl(input) {
                let url;
                if (isUrl(input)) {
                    url = input.startsWith('http') ? input : `https://${input}`;
                } else {
                    // Utiliser notre moteur de recherche personnalis√©
                    url = `./search-engine.html?q=${encodeURIComponent(input)}`;
                }
                
                const tabId = createTab(input.length > 20 ? input.substring(0, 20) + '...' : input, 'web');
                activateTab(tabId, 'web');
                
                const iframe = document.getElementById(`iframe-${tabId}`);
                if (iframe) {
                    iframe.src = url;
                    toolOutputRefs[tabId].history[0].url = url;
                    urlBar.value = url;
                }
            }

            // √âv√©nements de navigation
            searchButton.addEventListener('click', () => {
                const input = urlBar.value.trim();
                if (input && !input.startsWith('about:')) {
                    navigateToUrl(input);
                }
            });

            urlBar.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && globalEnterToSend.checked) {
                    const input = urlBar.value.trim();
                    if (input && !input.startsWith('about:')) {
                        navigateToUrl(input);
                    }
                }
            });

            // √âv√©nements globaux
            addTabButton.addEventListener('click', () => {
                const newTabId = createTab(`Onglet ${tabCounter}`, 'home');
                activateTab(newTabId, 'home');
            });
            
            // --- Logique de l'appui long et de la navigation ---
            function handlePressStart(action) {
                clearTimeout(longPressTimer);
                longPressTimer = setTimeout(() => {
                    clearTimeout(longPressTimer);
                    // Action de l'appui long sur le bouton suivant : d√©verrouiller Security Toolkit
                    if (action === 'forward') {
                        const securityTile = document.getElementById('security-toolkit-tile');
                        if (securityTile && securityTile.classList.contains('hidden')) {
                            securityTile.classList.remove('hidden');
                            alert('üîì Security Toolkit d√©verrouill√©\n\nLe Security Toolkit est maintenant disponible dans le Marketplace.');
                        }
                    } else {
                        // Action de l'appui long sur back : cr√©er un nouvel onglet
                        const newTabId = createTab('Autres Outils', 'other-tools');
                        activateTab(newTabId, 'other-tools');
                    }
                }, longPressDuration);
            }

            function handlePressEnd(action) {
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    // Si le timer n'a pas encore expir√©, c'est un appui court
                    if (action === 'back') {
                        goBack();
                    } else if (action === 'forward') {
                        goForward();
                    }
                }
            }
            
            backButton.addEventListener('mousedown', () => handlePressStart('back'));
            backButton.addEventListener('mouseup', () => handlePressEnd('back'));
            backButton.addEventListener('mouseleave', () => clearTimeout(longPressTimer));
            backButton.addEventListener('touchstart', () => handlePressStart('back'), { passive: true });
            backButton.addEventListener('touchend', () => handlePressEnd('back'), { passive: true });

            forwardButton.addEventListener('mousedown', () => handlePressStart('forward'));
            forwardButton.addEventListener('mouseup', () => handlePressEnd('forward'));
            forwardButton.addEventListener('mouseleave', () => clearTimeout(longPressTimer));
            forwardButton.addEventListener('touchstart', () => handlePressStart('forward'), { passive: true });
            forwardButton.addEventListener('touchend', () => handlePressEnd('forward'), { passive: true });

            // Exposer handleHotUpdate globalement pour les mises √† jour
            window.handleHotUpdate = handleHotUpdate;
            
            // Cr√©er l'onglet initial
            const homeTabId = createTab('Accueil', 'home');
            
            // D√©finir l'onglet initial comme actif
            activateTab(homeTabId, 'home');
            
            // Ajouter les √©v√©nements pour la recherche depuis la page d'accueil
            setTimeout(() => {
                const homeSearch = document.getElementById('home-search');
                const homeSearchBtn = document.getElementById('home-search-btn');
                
                if (homeSearch && homeSearchBtn) {
                    const performHomeSearch = () => {
                        const input = homeSearch.value.trim();
                        if (input) {
                            navigateToUrl(input);
                        }
                    };
                    
                    homeSearchBtn.addEventListener('click', performHomeSearch);
                    homeSearch.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') performHomeSearch();
                    });
                }
            }, 100);

            // Syst√®me de languettes en bas de fen√™tre
            const bottomTabsHTML = `
                <!-- Conteneurs des menus -->
                <div id="tools-menu" class="fixed bottom-16 left-0 w-full bg-[#2D2D2D] p-4 shadow-lg hidden transform transition-all duration-300">
                    <div class="flex justify-around">
                        <button id="toolbar-ask" class="px-4 py-2 bg-success text-black font-medium rounded-full hover:bg-green-600 transition-colors duration-200">Poser une question</button>
                        <button id="toolbar-plan" class="px-4 py-2 bg-success text-black font-medium rounded-full hover:bg-green-600 transition-colors duration-200">G√©n√©rer un plan</button>
                        <button id="toolbar-speak" class="px-4 py-2 bg-success text-black font-medium rounded-full hover:bg-green-600 transition-colors duration-200">Synth√®se vocale</button>
                        <button id="toolbar-ai-system" class="px-4 py-2 bg-success text-black font-medium rounded-full hover:bg-green-600 transition-colors duration-200">AI System Manager</button>
                    </div>
                </div>
                
                <div id="osint-submenu" class="fixed bottom-32 left-0 w-full bg-[#1a365d] p-4 shadow-lg hidden transform transition-all duration-300">
                    <div class="flex justify-center space-x-6">
                        <div class="bg-blue-800 p-3 rounded-lg cursor-pointer hover:bg-blue-700 transition-colors" id="osint-research-tile">
                            <h3 class="text-white font-bold">üîé OSINT Research</h3>
                            <p class="text-blue-200 text-sm">Recherche email, IP, domaine</p>
                        </div>
                        <div class="bg-purple-800 p-3 rounded-lg cursor-pointer hover:bg-purple-700 transition-colors" id="incogni-me-tile">
                            <h3 class="text-white font-bold">üïµÔ∏è Incogni-Me</h3>
                            <p class="text-purple-200 text-sm">Gestion empreinte num√©rique</p>
                        </div>
                        <div class="bg-green-800 p-3 rounded-lg cursor-pointer hover:bg-green-700 transition-colors" id="data-analyzer-tile">
                            <h3 class="text-white font-bold">üìä Data Analyzer</h3>
                            <p class="text-green-200 text-sm">Analyse et visualisation</p>
                        </div>
                    </div>
                </div>
                
                <div id="marketplace-menu" class="fixed bottom-16 left-0 w-full bg-[#2D2D2D] p-4 shadow-lg hidden transform transition-all duration-300">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="bg-red-900 border-2 border-red-500 p-4 rounded-lg shadow cursor-pointer hidden" id="security-toolkit-tile">
                            <h2 class="text-lg font-bold text-red-200">üõ°Ô∏è Security Toolkit ‚ö†Ô∏è</h2>
                            <p class="text-sm text-red-300">KillRAM, BadUSB, USBKiller - DANGEREUX</p>
                            <div class="mt-2 text-xs text-red-400 bg-red-800 p-1 rounded">‚ö†Ô∏è Outils destructeurs - Risques √©lev√©s</div>
                        </div>
                        <div class="bg-blue-900 border-2 border-blue-500 p-4 rounded-lg shadow cursor-pointer" id="osint-toolkit-tile">
                            <h2 class="text-lg font-bold text-blue-200">üîç OSINT Toolkit</h2>
                            <p class="text-sm text-blue-300">Intelligence sources ouvertes - 3 outils</p>
                            <div class="mt-2 text-xs text-blue-400 bg-blue-800 p-1 rounded">üîé Recherche, Anonymisation, Analyse</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow cursor-pointer" id="weather-tile">
                            <h2 class="text-lg font-bold text-gray-800">üå§Ô∏è M√©t√©o</h2>
                            <p class="text-sm text-gray-600">Consultez les pr√©visions m√©t√©o actuelles.</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow cursor-pointer" id="network-toolkit-tile">
                            <h2 class="text-lg font-bold text-gray-800">üåê Network Tool Kit</h2>
                            <p class="text-sm text-gray-600">Outils r√©seau : Ping, Scan, Test vitesse, WiFi.</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow cursor-pointer" id="marketplace-tile">
                            <h2 class="text-lg font-bold text-gray-800">üè™ Marketplace</h2>
                            <p class="text-sm text-gray-600">T√©l√©chargez de nouvelles extensions.</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow cursor-pointer" id="usb-manager-tile">
                            <h2 class="text-lg font-bold text-gray-800">üîå Gestionnaire USB</h2>
                            <p class="text-sm text-gray-600">G√©rez vos p√©riph√©riques USB connect√©s.</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow cursor-pointer" id="system-monitor-tile">
                            <h2 class="text-lg font-bold text-gray-800">üìä System Monitor</h2>
                            <p class="text-sm text-gray-600">Surveillez les performances de votre syst√®me.</p>
                        </div>
                    </div>
                </div>
                
                <div id="settings-menu" class="fixed bottom-16 left-0 w-full bg-[#2D2D2D] p-4 shadow-lg hidden transform transition-all duration-300">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Param√®tres de l'Application</h3>
                    <div class="max-w-md mx-auto space-y-4">
                        <div class="flex items-center justify-between bg-[#374151] p-3 rounded-lg">
                            <label for="theme-select" class="text-gray-300">Th√®me de l'interface</label>
                            <select id="theme-select" class="bg-[#1E1E1E] text-white rounded px-2 py-1" disabled>
                                <option value="dark">Sombre (D√©faut)</option>
                                <option value="light">Clair (Bient√¥t)</option>
                            </select>
                        </div>
                        <div class="flex items-center justify-between bg-[#374151] p-3 rounded-lg">
                            <span class="text-gray-300">Vider le cache de l'application</span>
                            <button id="clear-cache-button" class="px-3 py-1 bg-orange-500 text-black text-sm rounded hover:bg-orange-600">Vider</button>
                        </div>
                        <!-- Param√®tres de pseudo -->
                        <div class="bg-[#374151] p-3 rounded-lg space-y-3">
                            <h4 class="text-md font-semibold text-white">Pseudo</h4>
                            <div class="flex items-center space-x-2">
                                <input type="text" id="pseudo-input" placeholder="Votre pseudo" class="bg-[#1E1E1E] text-white text-sm rounded px-3 py-1 w-32 focus:outline-none focus:ring-1 focus:ring-success">
                                <button id="pseudo-validate" class="px-3 py-1 bg-success text-black text-sm rounded hover:bg-green-600 transition-colors duration-200">Valider</button>
                            </div>
                        </div>
                        <!-- Param√®tres de t√©l√©chargement -->
                        <div class="bg-[#374151] p-3 rounded-lg space-y-3">
                            <h4 class="text-md font-semibold text-white">T√©l√©chargements</h4>
                            <div class="flex items-center justify-between">
                                <label for="download-location" class="text-gray-300 text-sm">Emplacement</label>
                                <div class="flex items-center">
                                    <input type="text" id="download-location" value="C:\Users\Utilisateur\T√©l√©chargements" class="bg-[#1E1E1E] text-white text-sm rounded-l px-2 py-1 w-48" readonly>
                                    <button class="px-2 py-1 bg-gray-600 text-white text-sm rounded-r hover:bg-gray-700" onclick="alert('Fonctionnalit√© non impl√©ment√©e.')">Modifier</button>
                                </div>
                            </div>
                            <div class="flex items-center justify-between">
                                <label for="always-ask-download" class="text-gray-300 text-sm">Toujours demander o√π enregistrer</label>
                                <label class="toggle-switch relative inline-block w-10 h-5">
                                    <input type="checkbox" id="always-ask-download" class="opacity-0 w-0 h-0">
                                    <span class="slider absolute cursor-pointer top-0 left-0 right-0 bottom-0 bg-gray-500 transition-all duration-300 rounded-full"></span>
                                    <span class="slider-dot absolute content-[''] h-4 w-4 left-0.5 bottom-0.5 bg-white transition-all duration-300 rounded-full"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Languettes -->
                <div id="bottom-tabs" class="fixed bottom-0 left-0 w-full flex justify-center space-x-4 bg-[#1E1E1E] py-2">
                    <div id="tab-tools" class="bg-[#555] text-white px-6 py-3 rounded-t-lg cursor-pointer shadow-lg hover:bg-[#666] transition-colors duration-200">
                        <span class="text-sm font-medium">üõ†Ô∏è Outils</span>
                    </div>
                    <div id="tab-marketplace" class="bg-[#555] text-white px-6 py-3 rounded-t-lg cursor-pointer shadow-lg hover:bg-[#666] transition-colors duration-200">
                        <span class="text-sm font-medium">üè™ Marketplace</span>
                    </div>
                    <div id="tab-settings" class="bg-[#555] text-white px-6 py-3 rounded-t-lg cursor-pointer shadow-lg hover:bg-[#666] transition-colors duration-200">
                        <span class="text-sm font-medium">‚öôÔ∏è Param√®tres</span>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', bottomTabsHTML);

            // Variables pour g√©rer l'√©tat des languettes
            let activeBottomTab = null;
            let osintSubmenuOpen = false;
            const toolsMenu = document.getElementById('tools-menu');
            const marketplaceMenu = document.getElementById('marketplace-menu');
            const settingsMenu = document.getElementById('settings-menu');
            const osintSubmenu = document.getElementById('osint-submenu');
            const tabTools = document.getElementById('tab-tools');
            const tabMarketplace = document.getElementById('tab-marketplace');
            const tabSettings = document.getElementById('tab-settings');

            // Fonction pour basculer les menus
            function toggleBottomMenu(tabName) {
                const isCurrentlyActive = activeBottomTab === tabName;
                
                // Fermer tous les menus
                toolsMenu.classList.add('hidden');
                marketplaceMenu.classList.add('hidden');
                settingsMenu.classList.add('hidden');
                osintSubmenu.classList.add('hidden');
                osintSubmenuOpen = false;
                
                tabTools.classList.remove('bg-success');
                tabMarketplace.classList.remove('bg-success');
                tabSettings.classList.remove('bg-success');
                
                tabTools.classList.add('bg-[#555]');
                tabMarketplace.classList.add('bg-[#555]');
                tabSettings.classList.add('bg-[#555]');
                
                if (!isCurrentlyActive) {
                    // Ouvrir le menu s√©lectionn√©
                    if (tabName === 'tools') {
                        toolsMenu.classList.remove('hidden');
                        tabTools.classList.remove('bg-[#555]');
                        tabTools.classList.add('bg-success');
                    } else if (tabName === 'marketplace') {
                        marketplaceMenu.classList.remove('hidden');
                        tabMarketplace.classList.remove('bg-[#555]');
                        tabMarketplace.classList.add('bg-success');
                    } else if (tabName === 'settings') {
                        settingsMenu.classList.remove('hidden');
                        tabSettings.classList.remove('bg-[#555]');
                        tabSettings.classList.add('bg-success');
                    }
                    activeBottomTab = tabName;
                } else {
                    // Si on clique sur la languette d√©j√† active, on la ferme
                    activeBottomTab = null;
                }
            }

            // √âv√©nements des languettes
            tabTools.addEventListener('click', () => toggleBottomMenu('tools'));
            tabMarketplace.addEventListener('click', () => toggleBottomMenu('marketplace'));
            tabSettings.addEventListener('click', () => {
                // Ouvrir un onglet param√®tres au lieu du tiroir
                const tabId = createTab('‚öôÔ∏è Param√®tres', 'settings-tab');
                activateTab(tabId, 'settings-tab');
            });

            // Logique des param√®tres
            const clearCacheButton = document.getElementById('clear-cache-button');
            clearCacheButton.addEventListener('click', () => {
                if (confirm("√ätes-vous s√ªr de vouloir vider le cache ?\nCela r√©initialisera toutes les donn√©es de l'application (onglets, historique, param√®tres) et rechargera la page.")) {
                    localStorage.clear();
                    alert("Le cache a √©t√© vid√©. L'application va maintenant red√©marrer.");
                    location.reload();
                }
            });

            const alwaysAskDownloadToggle = document.getElementById('always-ask-download');
            const saveDownloadSettings = () => localStorage.setItem('alwaysAskDownload', alwaysAskDownloadToggle.checked);
            const loadDownloadSettings = () => {
                const savedValue = localStorage.getItem('alwaysAskDownload');
                alwaysAskDownloadToggle.checked = savedValue === 'true';
            };
            loadDownloadSettings();
            alwaysAskDownloadToggle.addEventListener('change', saveDownloadSettings);

            // Gestion du pseudo
            const pseudoInput = document.getElementById('pseudo-input');
            const pseudoValidate = document.getElementById('pseudo-validate');
            
            const savePseudo = () => {
                const pseudo = pseudoInput.value.trim();
                if (pseudo) {
                    localStorage.setItem('userPseudo', pseudo);
                    alert(`Pseudo d√©fini: ${pseudo}`);
                }
            };
            
            const loadPseudo = () => {
                const savedPseudo = localStorage.getItem('userPseudo');
                if (savedPseudo) pseudoInput.value = savedPseudo;
            };
            
            loadPseudo();
            pseudoValidate.addEventListener('click', savePseudo);
            pseudoInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') savePseudo();
            });

            // √âv√©nements des boutons de la sidebar
            document.getElementById('ai-system-button').addEventListener('click', () => {
                const tabId = createTab('ü§ñ AI System Manager', 'ai-system');
                activateTab(tabId, 'ai-system');
            });

            // √âv√©nements des boutons d'outils
            document.getElementById('toolbar-ask').addEventListener('click', () => {
                handleAskCommand('');
                toggleBottomMenu(null); // Fermer le menu apr√®s action
            });
            document.getElementById('toolbar-plan').addEventListener('click', () => {
                handlePlanCommand('');
                toggleBottomMenu(null);
            });
            document.getElementById('toolbar-speak').addEventListener('click', () => {
                handleSpeakCommand();
                toggleBottomMenu(null);
            });
            document.getElementById('toolbar-ai-system').addEventListener('click', () => {
                const tabId = createTab('ü§ñ AI System Manager', 'ai-system');
                activateTab(tabId, 'ai-system');
                toggleBottomMenu(null);
            });

            // √âv√©nements des tuiles marketplace
            const securityTile = document.getElementById('security-toolkit-tile');
            if (securityTile) {
                securityTile.addEventListener('click', () => {
                    if (confirm('‚ö†Ô∏è AVERTISSEMENT CRITIQUE\n\nLe Security Toolkit contient des outils dangereux :\n‚Ä¢ KillRAM (crash syst√®me)\n‚Ä¢ BadUSB (ex√©cution malveillante)\n‚Ä¢ USBKiller (destruction mat√©rielle)\n\nCes outils peuvent causer des dommages irr√©versibles.\nVoulez-vous vraiment continuer ?')) {
                        const tabId = createTab('üõ°Ô∏è Security Toolkit', 'security-toolkit');
                        activateTab(tabId, 'security-toolkit');
                        toggleBottomMenu(null);
                    }
                });
            }
            
            document.getElementById('osint-toolkit-tile').addEventListener('click', () => {
                const tabId = createTab('üîç OSINT Toolkit', 'osint-container');
                activateTab(tabId, 'osint-container');
                toggleBottomMenu(null);
            });
            
            // √âv√©nements des outils OSINT
            document.getElementById('osint-research-tile').addEventListener('click', () => {
                const tabId = createTab('üîç OSINT Research', 'osint-research');
                activateTab(tabId, 'osint-research');
                osintSubmenu.classList.add('hidden');
                osintSubmenuOpen = false;
                toggleBottomMenu(null);
            });
            
            document.getElementById('incogni-me-tile').addEventListener('click', () => {
                const tabId = createTab('üïµÔ∏è Incogni-Me', 'incogni-me');
                activateTab(tabId, 'incogni-me');
                osintSubmenu.classList.add('hidden');
                osintSubmenuOpen = false;
                toggleBottomMenu(null);
            });
            
            document.getElementById('data-analyzer-tile').addEventListener('click', () => {
                const tabId = createTab('üìä Data Analyzer', 'data-analyzer');
                activateTab(tabId, 'data-analyzer');
                osintSubmenu.classList.add('hidden');
                osintSubmenuOpen = false;
                toggleBottomMenu(null);
            });
            
            document.getElementById('weather-tile').addEventListener('click', () => {
                const tabId = createTab('üå§Ô∏è M√©t√©o', 'weather');
                activateTab(tabId, 'weather');
                toggleBottomMenu(null);
            });
            
            document.getElementById('marketplace-tile').addEventListener('click', () => {
                const tabId = createTab('Marketplace', 'marketplace');
                activateTab(tabId, 'marketplace');
                toggleBottomMenu(null);
            });

            document.getElementById('network-toolkit-tile').addEventListener('click', () => {
                const tabId = createTab('üåê Network Tool Kit', 'network-toolkit');
                activateTab(tabId, 'network-toolkit');
                toggleBottomMenu(null);
            });

            document.getElementById('usb-manager-tile').addEventListener('click', () => {
                const tabId = createTab('üîå Gestionnaire USB', 'usb-manager');
                activateTab(tabId, 'usb-manager');
                toggleBottomMenu(null);
            });

            document.getElementById('system-monitor-tile').addEventListener('click', () => {
                const tabId = createTab('üìä System Monitor', 'system-monitor');
                activateTab(tabId, 'system-monitor');
                toggleBottomMenu(null);
            });

            // Gestion du slider Enter = Envoyer pour chaque champ de saisie
            document.querySelectorAll('.enter-toggle input').forEach(slider => {
                slider.addEventListener('change', (e) => {
                    const isEnabled = e.target.checked;
                    localStorage.setItem('enterToSendEnabled', isEnabled);
                });
            });

            // Charger la pr√©f√©rence sauvegard√©e
            const savedPreference = localStorage.getItem('enterToSendEnabled');
            if (savedPreference !== null) {
                document.querySelectorAll('.enter-toggle input').forEach(slider => {
                    slider.checked = savedPreference === 'true';
                });
            }
        });
    </script>
</body>
</html>
