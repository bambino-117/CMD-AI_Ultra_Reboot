<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI System Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'bg-primary': '#0D1117',
                        'bg-secondary': '#1E1E1E',
                        'bg-tertiary': '#2D2D2D',
                        'success': '#4CAF50',
                        'error': '#F44336',
                        'warning': '#FF9800'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-bg-primary text-white min-h-screen">
    <div class="flex flex-col h-screen p-4">
        <!-- Header -->
        <div class="flex items-center justify-between mb-4">
            <h1 class="text-2xl font-bold">ü§ñ AI System Manager</h1>
            <div class="flex items-center space-x-2">
                <div id="llm-status" class="px-3 py-1 rounded text-sm bg-warning text-black">LLM: D√©connect√©</div>
                <div id="shell-status" class="px-3 py-1 rounded text-sm bg-warning text-black">Shell: D√©connect√©</div>
                <button id="toggle-shell" class="px-4 py-2 bg-success text-black rounded hover:bg-green-600 transition-colors">D√©marrer Shell</button>
            </div>
        </div>

        <!-- Chat Container -->
        <div class="flex-1 bg-bg-secondary rounded-lg flex flex-col">
            <!-- Messages -->
            <div id="chat-messages" class="flex-1 p-4 overflow-y-auto space-y-4">
                <div class="flex items-start space-x-3">
                    <div class="w-8 h-8 bg-success rounded-full flex items-center justify-center text-black font-bold">AI</div>
                    <div class="bg-bg-tertiary rounded-lg p-3 max-w-[80%]">
                        <p>Bonjour ! Je suis votre assistant IA pour g√©rer votre syst√®me. Vous pouvez me demander d'effectuer des t√¢ches comme :</p>
                        <ul class="mt-2 text-sm text-gray-300">
                            <li>‚Ä¢ Lister les fichiers d'un dossier</li>
                            <li>‚Ä¢ V√©rifier l'√©tat du syst√®me</li>
                            <li>‚Ä¢ G√©rer les processus</li>
                            <li>‚Ä¢ D√©bloater avec Chris Titus Tech</li>
                            <li>‚Ä¢ Maintenance : chkdsk, sfc, dism</li>
                            <li>‚Ä¢ Nettoyer les fichiers temporaires</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-4 border-t border-bg-tertiary">
                <div class="flex space-x-2">
                    <input 
                        type="text" 
                        id="user-input" 
                        placeholder="Demandez-moi d'effectuer une t√¢che syst√®me..."
                        class="flex-1 bg-bg-tertiary text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-success"
                    >
                    <button id="send-button" class="px-6 py-2 bg-success text-black rounded-lg hover:bg-green-600 transition-colors font-medium">
                        Envoyer
                    </button>
                </div>
                <div class="flex items-center mt-2 text-sm text-gray-400">
                    <input type="checkbox" id="auto-execute" class="mr-2">
                    <label for="auto-execute">Ex√©cuter automatiquement les commandes sugg√©r√©es</label>
                </div>
                <div class="mt-2">
                    <p class="text-xs text-gray-400 mb-2"><strong>Suggestions rapides :</strong></p>
                    <div class="flex flex-wrap gap-2">
                        <button class="suggestion-btn px-2 py-1 bg-bg-tertiary text-xs text-gray-300 rounded hover:bg-success hover:text-black transition-colors" data-suggestion="d√©bloat avec chris titus">üßπ D√©bloat CTT</button>
                        <button class="suggestion-btn px-2 py-1 bg-bg-tertiary text-xs text-gray-300 rounded hover:bg-success hover:text-black transition-colors" data-suggestion="v√©rifier disque avec chkdsk">üíæ ChkDsk</button>
                        <button class="suggestion-btn px-2 py-1 bg-bg-tertiary text-xs text-gray-300 rounded hover:bg-success hover:text-black transition-colors" data-suggestion="r√©parer fichiers syst√®me avec sfc">üîß SFC Scan</button>
                        <button class="suggestion-btn px-2 py-1 bg-bg-tertiary text-xs text-gray-300 rounded hover:bg-success hover:text-black transition-colors" data-suggestion="nettoyer fichiers temp">üóëÔ∏è Clean Temp</button>
                        <button class="suggestion-btn px-2 py-1 bg-bg-tertiary text-xs text-gray-300 rounded hover:bg-success hover:text-black transition-colors" data-suggestion="d√©fragmenter le disque">‚ö° Defrag</button>
                        <button class="suggestion-btn px-2 py-1 bg-bg-tertiary text-xs text-gray-300 rounded hover:bg-success hover:text-black transition-colors" data-suggestion="lister les processus">üìä Processus</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class AISystemManager {
            constructor() {
                this.shellActive = false;
                this.llmConnected = false;
                this.chatMessages = document.getElementById('chat-messages');
                this.userInput = document.getElementById('user-input');
                this.sendButton = document.getElementById('send-button');
                this.toggleShellButton = document.getElementById('toggle-shell');
                this.shellStatus = document.getElementById('shell-status');
                this.llmStatus = document.getElementById('llm-status');
                this.autoExecute = document.getElementById('auto-execute');
                
                this.initializeEventListeners();
                this.checkEnterToSendSetting();
                this.checkLLMConnection();
            }

            async checkLLMConnection() {
                try {
                    // Test de connexion √† Groq
                    const testResponse = await this.queryLLM('test');
                    this.llmConnected = true;
                    this.llmStatus.textContent = 'LLM: Connect√© (Groq)';
                    this.llmStatus.className = 'px-3 py-1 rounded text-sm bg-success text-black';
                } catch (error) {
                    this.llmStatus.textContent = 'LLM: Local uniquement';
                    this.llmStatus.className = 'px-3 py-1 rounded text-sm bg-warning text-black';
                }
            }

            initializeEventListeners() {
                this.sendButton.addEventListener('click', () => this.sendMessage());
                this.toggleShellButton.addEventListener('click', () => this.toggleShell());
                
                this.userInput.addEventListener('keydown', (e) => {
                    const enterToSend = localStorage.getItem('enterToSend') === 'true';
                    if (e.key === 'Enter' && enterToSend) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                // G√©rer les suggestions cliquables
                document.querySelectorAll('.suggestion-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const suggestion = btn.getAttribute('data-suggestion');
                        this.userInput.value = suggestion;
                        this.sendMessage();
                    });
                });

                // √âcouter les messages du parent pour la synchronisation Enter-to-Send
                window.addEventListener('message', (event) => {
                    if (event.data.type === 'enterToSendToggle') {
                        // Pas besoin d'action sp√©cifique, on v√©rifie localStorage √† chaque frappe
                    }
                });
            }

            checkEnterToSendSetting() {
                // V√©rifier le r√©glage au chargement
                const enterToSend = localStorage.getItem('enterToSend') === 'true';
                // Optionnel: afficher un indicateur visuel
            }

            toggleShell() {
                this.shellActive = !this.shellActive;
                
                if (this.shellActive) {
                    this.shellStatus.textContent = 'Shell: Connect√©';
                    this.shellStatus.className = 'px-3 py-1 rounded text-sm bg-success text-black';
                    this.toggleShellButton.textContent = 'Arr√™ter Shell';
                    this.toggleShellButton.className = 'px-4 py-2 bg-error text-white rounded hover:bg-red-600 transition-colors';
                    this.addMessage('system', 'Shell PowerShell d√©marr√© en arri√®re-plan. Pr√™t √† ex√©cuter vos commandes.');
                } else {
                    this.shellStatus.textContent = 'Shell: D√©connect√©';
                    this.shellStatus.className = 'px-3 py-1 rounded text-sm bg-warning text-black';
                    this.toggleShellButton.textContent = 'D√©marrer Shell';
                    this.toggleShellButton.className = 'px-4 py-2 bg-success text-black rounded hover:bg-green-600 transition-colors';
                    this.addMessage('system', 'Shell PowerShell arr√™t√©.');
                }
            }

            async sendMessage() {
                const message = this.userInput.value.trim();
                if (!message) return;

                this.addMessage('user', message);
                this.userInput.value = '';

                if (!this.shellActive) {
                    this.addMessage('ai', 'Veuillez d\'abord d√©marrer le shell pour que je puisse ex√©cuter des commandes syst√®me.');
                    return;
                }

                // Simuler la r√©flexion de l'IA
                this.addMessage('ai', 'Analyse de votre demande...', true);
                
                setTimeout(() => {
                    this.processUserRequest(message);
                }, 1000);
            }

            async processUserRequest(message) {
                // Supprimer le message "Analyse..."
                const lastMessage = this.chatMessages.lastElementChild;
                if (lastMessage && lastMessage.querySelector('.thinking')) {
                    lastMessage.remove();
                }

                // Essayer d'abord l'interpr√©tation locale
                let command = this.interpretCommand(message);
                
                if (!command) {
                    // Si pas de correspondance locale, utiliser le LLM
                    try {
                        const aiResponse = await this.queryLLM(message);
                        command = this.extractCommandFromAI(aiResponse);
                        
                        if (command) {
                            this.addMessage('ai', `Bas√© sur votre demande, je sugg√®re :\n\`${command}\``);
                        } else {
                            this.addMessage('ai', aiResponse || 'Je n\'ai pas pu interpr√©ter votre demande.');
                            return;
                        }
                    } catch (error) {
                        this.addMessage('ai', 'Erreur de connexion au LLM. Utilisation des r√®gles locales uniquement.');
                        return;
                    }
                } else {
                    this.addMessage('ai', `Je vais ex√©cuter la commande suivante :\n\`${command}\``);
                }
                
                if (this.autoExecute.checked) {
                    setTimeout(() => this.executeCommand(command), 500);
                } else {
                    this.addCommandConfirmation(command);
                }
            }

            async queryLLM(message) {
                const API_KEY = 'gsk_YOUR_API_KEY_HERE'; // Remplacer par votre cl√© Groq
                
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'llama-3.1-8b-instant',
                        messages: [{
                            role: 'system',
                            content: 'Tu es un assistant syst√®me Windows. R√©ponds UNIQUEMENT avec une commande PowerShell appropri√©e entre backticks ou explique bri√®vement. Sois concis.'
                        }, {
                            role: 'user',
                            content: message
                        }],
                        max_tokens: 150,
                        temperature: 0.1
                    })
                });
                
                if (!response.ok) throw new Error('LLM unavailable');
                const data = await response.json();
                return data.choices[0].message.content;
            }

            extractCommandFromAI(aiResponse) {
                // Extraire les commandes PowerShell de la r√©ponse IA
                const cmdMatch = aiResponse.match(/`([^`]+)`/);
                if (cmdMatch) return cmdMatch[1];
                
                // Rechercher des patterns de commandes courantes
                if (aiResponse.toLowerCase().includes('get-process')) return 'Get-Process';
                if (aiResponse.toLowerCase().includes('get-childitem')) return 'Get-ChildItem';
                
                return null;
            }

            interpretCommand(message) {
                const msg = message.toLowerCase();
                
                // Patterns de commandes courantes
                if (msg.includes('lister') || msg.includes('voir') && msg.includes('fichier')) {
                    if (msg.includes('bureau')) return 'Get-ChildItem -Path "$env:USERPROFILE\\Desktop"';
                    if (msg.includes('document')) return 'Get-ChildItem -Path "$env:USERPROFILE\\Documents"';
                    return 'Get-ChildItem';
                }
                
                if (msg.includes('processus') || msg.includes('t√¢che')) {
                    return 'Get-Process | Select-Object Name, CPU, WorkingSet | Sort-Object CPU -Descending | Select-Object -First 10';
                }
                
                if (msg.includes('espace disque') || msg.includes('stockage')) {
                    return 'Get-WmiObject -Class Win32_LogicalDisk | Select-Object DeviceID, @{Name="Size(GB)";Expression={[math]::Round($_.Size/1GB,2)}}, @{Name="FreeSpace(GB)";Expression={[math]::Round($_.FreeSpace/1GB,2)}}';
                }
                
                if (msg.includes('syst√®me') && msg.includes('info')) {
                    return 'Get-ComputerInfo | Select-Object WindowsProductName, WindowsVersion, TotalPhysicalMemory';
                }
                
                if (msg.includes('r√©seau') || msg.includes('ip')) {
                    return 'Get-NetIPAddress -AddressFamily IPv4 | Where-Object {$_.IPAddress -ne "127.0.0.1"}';
                }
                
                // D√©bloatage et optimisation
                if (msg.includes('d√©bloat') || msg.includes('chris titus') || msg.includes('ctt')) {
                    return 'iwr -useb https://christitus.com/win | iex';
                }
                if (msg.includes('o&o') || msg.includes('shutup')) {
                    return 'Write-Host "T√©l√©chargez O&O ShutUp10++ depuis https://www.oo-software.com/en/shutup10"';
                }
                
                // Maintenance syst√®me
                if (msg.includes('chkdsk') || msg.includes('v√©rifier disque')) {
                    return 'chkdsk C: /f /r';
                }
                if (msg.includes('sfc') || msg.includes('fichiers syst√®me')) {
                    return 'sfc /scannow';
                }
                if (msg.includes('dism') || msg.includes('r√©parer image')) {
                    return 'DISM /Online /Cleanup-Image /RestoreHealth';
                }
                if (msg.includes('nettoyer') || msg.includes('temp')) {
                    return 'Get-ChildItem -Path $env:TEMP -Recurse | Remove-Item -Force -Recurse -ErrorAction SilentlyContinue';
                }
                if (msg.includes('d√©frag') || msg.includes('d√©fragment')) {
                    return 'Optimize-Volume -DriveLetter C -Defrag';
                }
                if (msg.includes('mise √† jour') || msg.includes('update')) {
                    return 'Get-WindowsUpdate -Install -AcceptAll -AutoReboot';
                }
                
                return null;
            }

            addCommandConfirmation(command) {
                const confirmDiv = document.createElement('div');
                confirmDiv.className = 'flex items-start space-x-3 mt-4';
                confirmDiv.innerHTML = `
                    <div class="w-8 h-8 bg-warning rounded-full flex items-center justify-center text-black font-bold">‚ö†Ô∏è</div>
                    <div class="bg-bg-tertiary rounded-lg p-3 max-w-[80%]">
                        <p class="mb-3">Voulez-vous ex√©cuter cette commande ?</p>
                        <div class="flex space-x-2">
                            <button class="execute-btn px-3 py-1 bg-success text-black rounded text-sm hover:bg-green-600">Ex√©cuter</button>
                            <button class="cancel-btn px-3 py-1 bg-error text-white rounded text-sm hover:bg-red-600">Annuler</button>
                        </div>
                    </div>
                `;
                
                this.chatMessages.appendChild(confirmDiv);
                this.scrollToBottom();
                
                confirmDiv.querySelector('.execute-btn').addEventListener('click', () => {
                    confirmDiv.remove();
                    this.executeCommand(command);
                });
                
                confirmDiv.querySelector('.cancel-btn').addEventListener('click', () => {
                    confirmDiv.remove();
                    this.addMessage('ai', 'Commande annul√©e.');
                });
            }

            async executeCommand(command) {
                this.addMessage('system', `Ex√©cution: ${command}`);
                
                try {
                    // Simuler l'ex√©cution de commande (en r√©alit√©, il faudrait une API backend)
                    const result = await this.simulateCommandExecution(command);
                    this.addMessage('system', `R√©sultat:\n${result}`, false, 'success');
                } catch (error) {
                    this.addMessage('system', `Erreur: ${error.message}`, false, 'error');
                }
            }

            async simulateCommandExecution(command) {
                // Simulation - en production, ceci ferait appel √† une API backend
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                if (command.includes('Get-ChildItem')) {
                    return `Directory: C:\\Users\\boris\\Desktop

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d-----        01/12/2024     10:30                Documents
d-----        01/12/2024     09:15                Images
-a----        01/12/2024     14:22           1024 exemple.txt`;
                }
                
                if (command.includes('Get-Process')) {
                    return `Name                     CPU WorkingSet
----                     --- ----------
chrome                  45.2   524288000
code                    23.1   314572800
explorer                12.5   104857600`;
                }
                
                return 'Commande ex√©cut√©e avec succ√®s.';
            }

            addMessage(sender, content, thinking = false, type = 'normal') {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'flex items-start space-x-3';
                
                let avatar, bgClass;
                if (sender === 'user') {
                    avatar = 'üë§';
                    bgClass = 'bg-blue-600';
                } else if (sender === 'ai') {
                    avatar = 'ü§ñ';
                    bgClass = 'bg-success';
                } else {
                    avatar = '‚öôÔ∏è';
                    bgClass = type === 'error' ? 'bg-error' : type === 'success' ? 'bg-success' : 'bg-warning';
                }
                
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 ${bgClass} rounded-full flex items-center justify-center text-black font-bold">${avatar}</div>
                    <div class="bg-bg-tertiary rounded-lg p-3 max-w-[80%] ${thinking ? 'thinking' : ''}">
                        <pre class="whitespace-pre-wrap text-sm">${content}</pre>
                        ${thinking ? '<div class="mt-2 text-xs text-gray-400">‚óè‚óè‚óè</div>' : ''}
                    </div>
                `;
                
                this.chatMessages.appendChild(messageDiv);
                this.scrollToBottom();
            }

            scrollToBottom() {
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }
        }

        // Initialiser l'application
        document.addEventListener('DOMContentLoaded', () => {
            new AISystemManager();
        });
    </script>
</body>
</html>