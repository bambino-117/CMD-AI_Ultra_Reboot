<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIVEAU 0 // CONFIGURATEUR</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/global.css') }}">
    <!-- NOUVEAU : Styles pour les ères technologiques -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/eras.css') }}">
    <style>
        /* --- Styles pour le formulaire de connexion (copiés de aboutissement.html) --- */
        .auth-box {
            background: rgba(0, 10, 8, 0.4);
            border: 1px solid rgba(0, 255, 204, 0.2);
            padding: 2rem;
            border-radius: 0.25rem;
            width: 100%;
            max-width: 500px; /* Un peu plus large pour s'intégrer */
            margin: 0 auto 2rem auto; /* Centrer et ajouter une marge en bas */
            box-shadow: 0 0 25px rgba(0, 255, 204, 0.1);
            backdrop-filter: blur(5px);
        }
        .auth-box.shake-effect { animation: shake 0.4s; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        .auth-box .form-field {
            margin-bottom: 1.2rem;
        }
        .auth-box .form-field label {
            display: block;
            margin-bottom: 0.4rem;
            color: rgba(0, 255, 204, 0.7);
            font-size: 0.9rem;
        }
        .auth-box .form-field input {
            width: 100%;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(0, 255, 204, 0.3);
            color: #00ffcc;
            font-family: inherit;
            font-size: 1.1rem;
            padding: 0.6rem;
            border-radius: 0.2rem;
            box-sizing: border-box;
        }
        #submit-btn {
            width: 100%;
            padding: 0.8rem;
            font-family: inherit; font-size: 1.1rem;
            cursor: pointer; border-radius: 0.2rem; transition: all 0.2s ease;
            background: #00ffcc; border: 1px solid #00ffcc; color: #0d0d0d;
        }
        #submit-btn:hover { box-shadow: 0 0 15px rgba(0, 255, 204, 0.7); }

        /* --- Notification System (copié de aboutissement.html) --- */
        #notification-container {
            position: fixed; top: 2vh; right: 2vw; z-index: 9999;
            display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;
        }
        .notification {
            padding: 0.8rem 1.2rem; background: rgba(255, 85, 85, 0.1);
            border-left: 3px solid #ff5555; color: #ff5555;
            border-radius: 0.2rem; box-shadow: 0 0 15px rgba(255, 85, 85, 0.2);
            backdrop-filter: blur(5px); animation: fadeInDown 0.5s ease forwards;
        }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <!-- Conteneur pour les notifications (nécessaire pour la connexion) -->
    <div id="notification-container"></div>

    <div class="container">
        <h1>[ NIVEAU 0 // CONFIGURATEUR ]</h1>

        <!-- NOUVEAU : Groupe d'Authentification -->
        <div class="settings-group" id="group-auth">
            <h2>Authentification</h2>
            <div id="auth-box" class="auth-box">
                <form id="login-form">
                    <div class="form-field">
                        <label for="username-input">Identifiant / Code Testeur</label>
                        <input type="text" id="username-input" autocomplete="username" required>
                    </div>
                    <div class="form-field">
                        <label for="password-input">Mot de Passe</label>
                        <input type="password" id="password-input" autocomplete="current-password" required>
                    </div>
                    <button type="submit" id="submit-btn">Connexion</button>
                </form>
            </div>
        </div>

        <!-- Groupe: Affichage & Navigation -->
        <div class="settings-group" id="group-display">
            <h2>Affichage & Navigation</h2>
            <div class="form-field">
                <label>Mode d'affichage</label>
                <div class="radio-group">
                    <label>
                        <input type="radio" name="display_mode" value="fullscreen">
                        Plein écran
                    </label>
                    <label>
                        <input type="radio" name="display_mode" value="windowed">
                        Fenêtré
                    </label>
                </div>
            </div>
            <div class="form-field">
                <label for="start_level">Niveau de démarrage</label>
                <input type="number" id="start_level" name="navigation.start_level">
            </div>
        </div>

        <!-- Groupe: IA -->
        <div class="settings-group" id="group-ai">
            <h2>Intelligence Artificielle</h2>
            <div class="form-field">
                <label for="ai_model">Modèle d'IA principal</label>
                <input type="text" id="ai_model" name="ai.model" placeholder="ex: deepseek-coder, gpt-4, ...">
            </div>
            <h3>Fournisseurs d'API</h3>
            <div class="provider-grid">
                <div class="provider-card">
                    <h3>DeepSeek</h3>
                    <div class="form-field">
                        <label for="deepseek_api_key">Clé API</label>
                        <input type="password" id="deepseek_api_key" name="ai.providers.deepseek.api_key">
                    </div>
                </div>
                <div class="provider-card">
                    <h3>OpenAI</h3>
                    <div class="form-field">
                        <label for="openai_api_key">Clé API</label>
                        <input type="password" id="openai_api_key" name="ai.providers.openai.api_key">
                    </div>
                </div>
                <div class="provider-card">
                    <h3>Google Gemini</h3>
                    <div class="form-field">
                        <label for="google_api_key">Clé API</label>
                        <input type="password" id="google_api_key" name="ai.providers.google.api_key">
                    </div>
                </div>
                <div class="provider-card">
                    <h3>Groq</h3>
                    <div class="form-field">
                        <label for="groq_api_key">Clé API</label>
                        <input type="password" id="groq_api_key" name="ai.providers.groq.api_key">
                    </div>
                </div>
                <div class="provider-card">
                    <h3>Ollama (Local)</h3>
                    <div class="form-field">
                        <label for="ollama_base_url">URL de base</label>
                        <input type="text" id="ollama_base_url" name="ai.providers.ollama.base_url">
                    </div>
                </div>
            </div>
        </div>

        <!-- Groupe: Utilisateur -->
        <div class="settings-group" id="group-user">
            <h2>Utilisateur & Sécurité</h2>
            <div class="form-field">
                <label for="user_pseudo">Pseudo</label>
                <input type="text" id="user_pseudo" name="user.pseudo">
            </div>
            <div class="form-field">
                <label for="user_password">Mot de passe du Bunker</label>
                <input type="password" id="user_password" name="user.password" placeholder="Laisser vide pour ne pas changer">
            </div>
            <div class="form-field">
                <label for="user_folder_path">Chemin du dossier Bunker</label>
                <input type="text" id="user_folder_path" name="user.user_folder_path">
            </div>
            <div class="form-field">
                <label for="hibp_api_key">Clé API "Have I Been Pwned"</label>
                <input type="password" id="hibp_api_key" name="user.api_keys.hibp_api_key">
            </div>
        </div>

        <!-- Groupe: VPN -->
        <div class="settings-group" id="group-vpn">
            <h2>VPN</h2>
            <div class="form-field">
                <label for="vpn_proxy_address">Adresse du proxy (ex: http://127.0.0.1:9050 pour Tor)</label>
                <input type="text" id="vpn_proxy_address" name="vpn.proxy_address">
            </div>
        </div>

        <!-- Actions -->
        <div class="actions">
            <button id="save-btn" class="btn btn-primary">Sauvegarder</button>
            <button id="reset-btn" class="btn btn-danger">Réinitialiser</button>
            <button id="back-btn" class="btn btn-secondary">Retour</button>
        </div>
    </div>

    <!-- NOUVEAU : Overlay pour l'effet de transition "glitch" -->
    <div id="glitch-overlay"></div>

    <script>
        window.addEventListener('pywebviewready', () => {
            // --- NOUVEAU : Logique de notification (copiée de aboutissement.html) ---
            function showNotification(message, type = 'error', duration = 4000) {
                const container = document.getElementById('notification-container');
                if (!container) return;

                const notif = document.createElement('div');
                notif.className = `notification ${type}`;
                notif.textContent = message;
                container.appendChild(notif);

                setTimeout(() => {
                    notif.style.transition = 'opacity 0.5s ease';
                    notif.style.opacity = '0';
                    notif.addEventListener('transitionend', () => notif.remove());
                }, duration);
            }

            // --- NOUVEAU : Logique du "Time-Scroll" (Phase 6.3) ---
            const body = document.body;
            const glitchOverlay = document.getElementById('glitch-overlay');
            const eras = [
                { name: 'era-cyberpunk', threshold: 0.5 },  // de 0% à 50%
                { name: 'era-classic',   threshold: 0.85 }, // de 50% à 85%
                { name: 'era-dos',       threshold: 1.01 }  // de 85% à 100% (1.01 pour inclure 100%)
            ];

            function updateEraStyle() {
                const scrollTop = window.scrollY;
                const docHeight = document.documentElement.scrollHeight;
                const winHeight = window.innerHeight;

                // Gérer le cas où le contenu n'est pas assez grand pour défiler
                if (docHeight <= winHeight) {
                    if (!body.classList.contains('era-cyberpunk')) {
                        eras.forEach(era => body.classList.remove(era.name));
                        body.classList.add('era-cyberpunk');
                    }
                    return;
                }

                const scrollPercent = scrollTop / (docHeight - winHeight);

                let newEra = eras[eras.length - 1].name; // Par défaut, la dernière ère
                for (const era of eras) {
                    if (scrollPercent < era.threshold) {
                        newEra = era.name;
                        break;
                    }
                }

                // Appliquer la classe seulement si elle a changé pour optimiser
                if (!body.classList.contains(newEra) && !glitchOverlay.classList.contains('active')) {
                    glitchOverlay.classList.add('active');

                    glitchOverlay.addEventListener('animationend', () => {
                        // Changer le style PENDANT que l'écran est "glitché"
                        eras.forEach(era => body.classList.remove(era.name));
                        body.classList.add(newEra);

                        // Cacher l'overlay une fois l'animation terminée
                        glitchOverlay.classList.remove('active');
                    }, { once: true }); // L'écouteur se supprime après exécution
                }
            }

            const formElements = document.querySelectorAll('input, select');
            let currentConfig = {};

            // Fonction pour définir une valeur dans un objet imbriqué
            function setNestedValue(obj, path, value) {
                const keys = path.split('.');
                let current = obj;
                for (let i = 0; i < keys.length - 1; i++) {
                    current = current[keys[i]] = current[keys[i]] || {};
                }
                current[keys[keys.length - 1]] = value;
            }

            // Fonction pour obtenir une valeur d'un objet imbriqué
            function getNestedValue(obj, path) {
                return path.split('.').reduce((o, k) => (o && o[k] !== 'undefined') ? o[k] : undefined, obj);
            }

            // Charger les paramètres
            async function loadSettings() {
                currentConfig = await window.pywebview.api.load_settings();
                formElements.forEach(el => {
                    const path = el.name;
                    if (!path) return;

                    const value = getNestedValue(currentConfig, path);
                    if (el.type === 'radio') {
                        el.checked = (el.value === value);
                    } else if (el.type !== 'password') { // Ne pas pré-remplir les mots de passe
                        el.value = value !== undefined ? value : '';
                    }
                });
            }

            // Sauvegarder les paramètres
            async function saveSettings() {
                const newConfig = JSON.parse(JSON.stringify(currentConfig)); // Deep copy
                formElements.forEach(el => {
                    const path = el.name;
                    if (!path) return;

                    if (el.type === 'radio') {
                        if (el.checked) {
                            setNestedValue(newConfig, path, el.value);
                        }
                    } else if (el.type === 'password') {
                        // Sauvegarder le mot de passe uniquement s'il a été modifié
                        if (el.value) {
                            setNestedValue(newConfig, path, el.value);
                        }
                    } else {
                        setNestedValue(newConfig, path, el.value);
                    }
                });

                const result = await window.pywebview.api.save_settings(newConfig);
                if (result.status === 'success') {
                    alert('Paramètres sauvegardés.');
                    currentConfig = newConfig; // Mettre à jour la config locale
                } else {
                    alert(`Erreur: ${result.message}`);
                }
            }

            // Réinitialiser les paramètres
            async function resetSettings() {
                if (confirm("Êtes-vous sûr de vouloir réinitialiser tous les paramètres à leurs valeurs par défaut ?")) {
                    const result = await window.pywebview.api.reset_settings_to_default();
                    if (result.status === 'success') {
                        alert(result.message);
                        await loadSettings(); // Recharger les paramètres pour afficher les valeurs par défaut
                    } else {
                        alert(`Erreur: ${result.message}`);
                    }
                }
            }

            // --- NOUVEAU : Logique d'authentification ---
            const loginForm = document.getElementById('login-form');
            const usernameInput = document.getElementById('username-input');
            const passwordInput = document.getElementById('password-input');
            const authBox = document.getElementById('auth-box');

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = usernameInput.value.trim();
                const password = passwordInput.value;

                if (!username || !password) {
                    showNotification("Identifiant et mot de passe requis.", 'error');
                    return;
                }

                const result = await window.pywebview.api.check_bunker_password(username, password);

                if (result.status === 'success') {
                    // Stocker le rôle de l'utilisateur pour une utilisation future
                    sessionStorage.setItem('userRole', result.role);
                    alert('Connexion réussie. Redirection...');
                    window.location.href = '/terminaux.html';
                } else {
                    showNotification(result.message || 'Identifiants incorrects.', 'error');
                    authBox.classList.add('shake-effect');
                    passwordInput.value = '';
                    passwordInput.focus();
                    setTimeout(() => authBox.classList.remove('shake-effect'), 500);
                }
            });


            // Listeners
            document.getElementById('save-btn').addEventListener('click', saveSettings);
            document.getElementById('reset-btn').addEventListener('click', resetSettings);
            document.getElementById('back-btn').addEventListener('click', () => {
                window.location.href = '/terminaux.html';
            });

            // Attacher l'événement de scroll et l'exécuter une fois au chargement
            window.addEventListener('scroll', updateEraStyle, { passive: true });
            updateEraStyle();

            // Chargement initial
            loadSettings();
        });
    </script>
</body>
</html>