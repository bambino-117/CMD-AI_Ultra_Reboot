<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIVEAU 0 // CONFIGURATEUR</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/global.css') }}">
    <!-- NOUVEAU : Styles pour les √®res technologiques -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/eras.css') }}">
    <style>
        /* --- Styles pour le formulaire de connexion (copi√©s de aboutissement.html) --- */
        .auth-box {
            background: rgba(0, 10, 8, 0.4);
            border: 1px solid rgba(0, 255, 204, 0.2);
            padding: 2rem;
            border-radius: 0.25rem;
            width: 100%;
            max-width: 500px; /* Un peu plus large pour s'int√©grer */
            margin: 0 auto 2rem auto; /* Centrer et ajouter une marge en bas */
            box-shadow: 0 0 25px rgba(0, 255, 204, 0.1);
            backdrop-filter: blur(5px);
        }
        .auth-box.shake-effect { animation: shake 0.4s; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        .auth-box .form-field {
            margin-bottom: 1.2rem;
        }
        .auth-box .form-field label {
            display: block;
            margin-bottom: 0.4rem;
            color: rgba(0, 255, 204, 0.7);
            font-size: 0.9rem;
        }
        .auth-box .form-field input {
            width: 100%;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(0, 255, 204, 0.3);
            color: #00ffcc;
            font-family: inherit;
            font-size: 1.1rem;
            padding: 0.6rem;
            border-radius: 0.2rem;
            box-sizing: border-box;
        }

        .auth-box .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .auth-box .form-actions button {
            flex-grow: 1;
            padding: 0.8rem;
            font-family: inherit;
            font-size: 1.1rem;
            cursor: pointer;
            border-radius: 0.2rem;
            transition: all 0.2s ease;
            border: 1px solid;
        }
        .auth-box .form-actions #submit-btn {
            background: #00ffcc;
            border-color: #00ffcc;
            color: #0d0d0d;
        }
        .auth-box .form-actions #submit-btn:hover {
            box-shadow: 0 0 15px rgba(0, 255, 204, 0.7);
        }
        .auth-box .form-actions .btn-secondary {
            background: transparent;
            border-color: rgba(170, 170, 170, 0.5);
            color: rgba(170, 170, 170, 0.8);
        }
        .auth-box .form-actions .btn-secondary:hover {
            background: rgba(170, 170, 170, 0.1);
            color: #fff;
            border-color: #fff;
        }

        /* --- Notification System (copi√© de aboutissement.html) --- */
        .settings-group .description {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: -0.5rem;
            margin-bottom: 1rem;
            font-style: italic;
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        /* NOUVEAU: Styles pour les champs de synchro */
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        .input-with-button {
            display: flex;
            gap: 0.5rem;
        }
        .input-with-button input {
            flex-grow: 1;
        }
        .input-with-button .btn {
            flex-shrink: 0;
        }

        .actions-grid .btn {
            width: 100%;
        }
        .btn.btn-warning {
            background: #ffcc00; border-color: #ffcc00; color: #0d0d0d;
        }
        .btn.btn-warning:hover { box-shadow: 0 0 15px rgba(255, 204, 0, 0.7); }
        .btn.btn-danger-outline {
            background: transparent; border-color: #ff5555; color: #ff5555;
        }
        .btn.btn-danger-outline:hover { background: rgba(255, 85, 85, 0.1); color: #ff5555; }

        #notification-container {
            position: fixed; top: 2vh; right: 2vw; z-index: 9999;
            display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;
        }
        .notification {
            padding: 0.8rem 1.2rem; background: rgba(255, 85, 85, 0.1);
            border-left: 3px solid #ff5555; color: #ff5555;
            border-radius: 0.2rem; box-shadow: 0 0 15px rgba(255, 85, 85, 0.2);
            backdrop-filter: blur(5px); animation: fadeInDown 0.5s ease forwards;
        }

        /* NOUVEAU: Styles pour la gestion des cl√©s API */
        .api-key-field {
            position: relative;
        }
        .api-key-field .toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .api-key-field .toggle-password:hover { opacity: 1; }
        .api-key-status {
            display: inline-block;
            width: 8px; height: 8px;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
        }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <!-- Conteneur pour les notifications (n√©cessaire pour la connexion) -->
    <div id="notification-container"></div>

    <div class="container">
        <h1>[ NIVEAU 0 // CONFIGURATEUR ]</h1>

        <!-- NOUVEAU : Le formulaire de connexion est maintenant conditionnel -->
        {% if not is_authenticated %}
        <div class="settings-group" id="group-auth">
            <h2>Authentification</h2>
            <div id="auth-box" class="auth-box">
                <form id="login-form">
                    <div class="form-field">
                        <label for="username-input">Identifiant / Code Testeur</label>
                        <input type="text" id="username-input" autocomplete="username" required>
                    </div>
                    <div class="form-field">
                        <label for="password-input">Mot de Passe</label>
                        <input type="password" id="password-input" autocomplete="current-password" required>
                    </div>
                    <div class="form-actions">
                        <button type="button" id="login-back-btn" class="btn-secondary">Retour</button>
                        <button type="submit" id="submit-btn">Connexion</button>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}

        {% if is_authenticated %}
        <!-- Groupe: Affichage & Navigation -->
        <div class="settings-group" id="group-display">
            <h2>Affichage & Navigation</h2>
            <div class="form-field">
                <label>Mode d'affichage</label>
                <div class="radio-group">
                    <label>
                        <input type="radio" name="display_mode" value="fullscreen">
                        Plein √©cran
                    </label>
                    <label>
                        <input type="radio" name="display_mode" value="windowed">
                        Fen√™tr√©
                    </label>
                </div>
            </div>
            <div class="form-field">
                <label for="start_level">Niveau de d√©marrage</label>
                <input type="number" id="start_level" name="navigation.start_level">
            </div>
        </div>

        <!-- Groupe: Utilisateur -->
        <div class="settings-group" id="group-user">
            <h2>Utilisateur & S√©curit√©</h2>
            <div class="form-field">
                <label for="user_pseudo">Pseudo</label>
                <input type="text" id="user_pseudo" name="user.pseudo">
            </div>
            <div class="form-field">
                <label for="user_password">Mot de passe du Bunker</label>
                <input type="password" id="user_password" name="user.password" placeholder="Laisser vide pour ne pas changer">
            </div>
            <div class="form-field">
                <label for="user_folder_path">Chemin du dossier Bunker</label>
                <input type="text" id="user_folder_path" name="user.user_folder_path">
            </div>
        </div>

        <!-- NOUVEAU Groupe: Cl√©s API -->
        <div class="settings-group" id="group-api-keys">
            <h2>Cl√©s API & Services Externes</h2>
            <div class="form-field">
                <label for="ai_model">Mod√®le d'IA principal</label>
                <input type="text" id="ai_model" name="ai.model" placeholder="ex: deepseek-coder, gpt-4, ...">
                <p class="description">Le nom du mod√®le d√©termine le fournisseur utilis√©.</p>
            </div>
            <div class="provider-grid">
                <div class="provider-card">
                    <h3>DeepSeek</h3>
                    <div class="form-field api-key-field">
                        <label for="deepseek_api_key"><span class="api-key-status"></span>Cl√© API</label>
                        <input type="password" id="deepseek_api_key" name="ai.providers.deepseek.api_key" autocomplete="off">
                        <span class="toggle-password">üëÅÔ∏è</span>
                    </div>
                </div>
                <div class="provider-card">
                    <h3>OpenAI</h3>
                    <div class="form-field api-key-field">
                        <label for="openai_api_key"><span class="api-key-status"></span>Cl√© API</label>
                        <input type="password" id="openai_api_key" name="ai.providers.openai.api_key" autocomplete="off">
                        <span class="toggle-password">üëÅÔ∏è</span>
                    </div>
                </div>
                <div class="provider-card">
                    <h3>Google Gemini</h3>
                    <div class="form-field api-key-field">
                        <label for="google_api_key"><span class="api-key-status"></span>Cl√© API</label>
                        <input type="password" id="google_api_key" name="ai.providers.google.api_key" autocomplete="off">
                        <span class="toggle-password">üëÅÔ∏è</span>
                    </div>
                </div>
                <div class="provider-card">
                    <h3>Groq</h3>
                    <div class="form-field api-key-field">
                        <label for="groq_api_key"><span class="api-key-status"></span>Cl√© API</label>
                        <input type="password" id="groq_api_key" name="ai.providers.groq.api_key" autocomplete="off">
                        <span class="toggle-password">üëÅÔ∏è</span>
                    </div>
                </div>
                <div class="provider-card">
                    <h3>Have I Been Pwned</h3>
                    <div class="form-field api-key-field">
                        <label for="hibp_api_key"><span class="api-key-status"></span>Cl√© API</label>
                        <input type="password" id="hibp_api_key" name="user.api_keys.hibp_api_key" autocomplete="off">
                        <span class="toggle-password">üëÅÔ∏è</span>
                    </div>
                </div>
            </div>
            <p class="description" style="margin-top: 1rem;">Les cl√©s API ne sont jamais affich√©es. Laissez un champ vide pour conserver la cl√© existante.</p>
        </div>

        <!-- Groupe: VPN -->
        <div class="settings-group" id="group-vpn">
            <h2>VPN</h2>
            <div class="form-field">
                <label for="vpn_proxy_address">Adresse du proxy (ex: http://127.0.0.1:9050 pour Tor)</label>
                <input type="text" id="vpn_proxy_address" name="vpn.proxy_address">
            </div>
        </div>

        <!-- NOUVEAU Groupe: Configuration Locale (Ollama) -->
        <div class="settings-group" id="group-local">
            <h2>Configuration Locale</h2>
            <div class="form-field">
                <label for="ollama_base_url">URL de base Ollama</label>
                <input type="text" id="ollama_base_url" name="ai.providers.ollama.base_url">
            </div>
        </div>

        <!-- NOUVEAU Groupe: Synchronisation -->
        <div class="settings-group" id="group-sync">
            <h2>Synchronisation</h2>
            <p class="description">Synchronisez votre Bunker en utilisant un service cloud tiers (Dropbox, Google Drive, etc.). L'application utilisera le dossier sp√©cifi√© comme racine pour le Bunker.</p>
            <div class="form-field">
                <label class="checkbox-label">
                    <input type="checkbox" id="sync_enabled" name="sync.enabled">
                    Activer la synchronisation
                </label>
            </div>
            <div class="form-field" id="sync-path-field" style="display: none;">
                <label for="sync_path">Chemin du dossier de synchronisation</label>
                <div class="input-with-button">
                    <input type="text" id="sync_path" name="sync.path" readonly>
                    <button type="button" id="browse-sync-btn" class="btn">Parcourir...</button>
                </div>
            </div>
        </div>

        <!-- Groupe: Actions de S√©curit√© (visible uniquement par le concepteur) -->
        {% if user_role == 'concepteur' %}
        <div class="settings-group" id="group-security">
            <h2>Actions de S√©curit√©</h2>
            <p class="description">Actions irr√©versibles. √Ä utiliser avec une extr√™me prudence.</p>
            <div class="actions-grid">
                <button id="clear-cache-btn" class="btn btn-warning">Vider le cache</button>
                <button id="kill-app-btn" class="btn btn-danger">Kill-app</button>
                <button id="crash-btn" class="btn btn-danger-outline">Crash</button>
                <a href="/admin/testers" class="btn">G√©rer les Acc√®s Testeur</a>
            </div>
        </div>
        {% endif %}

        <!-- Actions -->
        <div class="actions">
            <button id="save-btn" class="btn btn-primary">Sauvegarder</button>
            <button id="reset-btn" class="btn btn-danger">R√©initialiser</button>
            <button id="logout-btn" class="btn btn-secondary">D√©connexion</button>
            <button id="back-btn" class="btn btn-secondary">Retour</button>
        </div>
        {% endif %}
    </div>

    <!-- NOUVEAU : Overlay pour l'effet de transition "glitch" -->
    <div id="glitch-overlay"></div>

    <script>
        window.addEventListener('pywebviewready', () => {
            function showNotification(message, type = 'error', duration = 4000) {
                const container = document.getElementById('notification-container');
                if (!container) return;

                const notif = document.createElement('div');
                notif.className = `notification ${type}`;
                notif.textContent = message;
                container.appendChild(notif);

                setTimeout(() => {
                    notif.style.transition = 'opacity 0.5s ease';
                    notif.style.opacity = '0';
                    notif.addEventListener('transitionend', () => notif.remove());
                }, duration);
            }

            const body = document.body;
            const glitchOverlay = document.getElementById('glitch-overlay');
            const eras = [
                { name: 'era-cyberpunk', threshold: 0.5 },  // de 0% √† 50%
                { name: 'era-classic',   threshold: 0.85 }, // de 50% √† 85%
                { name: 'era-dos',       threshold: 1.01 }  // de 85% √† 100% (1.01 pour inclure 100%)
            ];

            function updateEraStyle() {
                const scrollTop = window.scrollY;
                const docHeight = document.documentElement.scrollHeight;
                const winHeight = window.innerHeight;

                // G√©rer le cas o√π le contenu n'est pas assez grand pour d√©filer
                if (docHeight <= winHeight) {
                    if (!body.classList.contains('era-cyberpunk')) {
                        eras.forEach(era => body.classList.remove(era.name));
                        body.classList.add('era-cyberpunk');
                    }
                    return;
                }

                const scrollPercent = scrollTop / (docHeight - winHeight);

                let newEra = eras[eras.length - 1].name; // Par d√©faut, la derni√®re √®re
                for (const era of eras) {
                    if (scrollPercent < era.threshold) {
                        newEra = era.name;
                        break;
                    }
                }

                // Appliquer la classe seulement si elle a chang√© pour optimiser
                if (!body.classList.contains(newEra) && !glitchOverlay.classList.contains('active')) {
                    glitchOverlay.classList.add('active');

                    glitchOverlay.addEventListener('animationend', () => {
                        // Changer le style PENDANT que l'√©cran est "glitch√©"
                        eras.forEach(era => body.classList.remove(era.name));
                        body.classList.add(newEra);

                        // Cacher l'overlay une fois l'animation termin√©e
                        glitchOverlay.classList.remove('active');
                    }, { once: true }); // L'√©couteur se supprime apr√®s ex√©cution
                }
            }

            {% if is_authenticated %}
            const formElements = document.querySelectorAll('input, select');
            let currentConfig = {};
            const syncEnabledCheckbox = document.getElementById('sync_enabled');
            const syncPathField = document.getElementById('sync-path-field');
            const syncPathInput = document.getElementById('sync_path');
            const browseSyncBtn = document.getElementById('browse-sync-btn');


            // Fonction pour d√©finir une valeur dans un objet imbriqu√©
            function setNestedValue(obj, path, value) {
                const keys = path.split('.');
                let current = obj;
                for (let i = 0; i < keys.length - 1; i++) {
                    current = current[keys[i]] = current[keys[i]] || {};
                }
                current[keys[keys.length - 1]] = value;
            }

            // Fonction pour obtenir une valeur d'un objet imbriqu√©
            function getNestedValue(obj, path) {
                return path.split('.').reduce((o, k) => (o && o[k] !== 'undefined') ? o[k] : undefined, obj);
            }

            function toggleSyncPathVisibility() {
                if (!syncEnabledCheckbox) return;
                syncPathField.style.display = syncEnabledCheckbox.checked ? 'block' : 'none';
            }

            if (syncEnabledCheckbox) {
                syncEnabledCheckbox.addEventListener('change', toggleSyncPathVisibility);
            }

            if (browseSyncBtn) {
                browseSyncBtn.addEventListener('click', async () => {
                    const result = await window.pywebview.api.open_folder_dialog();
                    if (result.status === 'success') {
                        syncPathInput.value = result.path;
                    }
                });
            }


            // Charger les param√®tres
            async function loadSettings() {
                currentConfig = await window.pywebview.api.load_settings();
                formElements.forEach(el => {
                    const path = el.name;
                    if (!path) return;

                    const value = getNestedValue(currentConfig, path);
                    if (el.type === 'radio') {
                        el.checked = (el.value === value);
                    } else if (el.type === 'checkbox') {
                        el.checked = !!value;
                    } else if (el.type !== 'password') { // Ne pas pr√©-remplir les mots de passe
                        el.value = value !== undefined ? value : '';
                    } else {
                        // NOUVEAU: G√©rer les indicateurs de statut pour les cl√©s API
                        const apiKeyField = el.closest('.api-key-field');
                        if (apiKeyField) {
                            const statusIndicator = apiKeyField.querySelector('.api-key-status');
                            const isConfigured = value && !value.includes('YOUR_') && value.length > 5;
                            statusIndicator.style.backgroundColor = isConfigured ? '#00ffcc' : '#ff5555';
                            statusIndicator.title = isConfigured ? 'Cl√© configur√©e' : 'Cl√© non configur√©e';
                        }
                    }
                });
                toggleSyncPathVisibility(); // Mettre √† jour la visibilit√© apr√®s le chargement
            }

            // Sauvegarder les param√®tres
            async function saveSettings() {
                const newConfig = JSON.parse(JSON.stringify(currentConfig)); // Deep copy
                formElements.forEach(el => {
                    const path = el.name;
                    if (!path) return;

                    if (el.type === 'radio') {
                        if (el.checked) {
                            setNestedValue(newConfig, path, el.value);
                        }
                    } else if (el.type === 'checkbox') {
                        setNestedValue(newConfig, path, el.checked);
                    } else if (el.type === 'password') {
                        // Sauvegarder le mot de passe uniquement s'il a √©t√© modifi√©
                        if (el.value) {
                            setNestedValue(newConfig, path, el.value);
                        }
                    } else {
                        setNestedValue(newConfig, path, el.value);
                    }
                });

                const result = await window.pywebview.api.save_settings(newConfig);
                if (result.status === 'success') {
                    alert('Param√®tres sauvegard√©s.');
                    // Recharger pour mettre √† jour les indicateurs de statut
                    await loadSettings();
                } else {
                    alert(`Erreur: ${result.message}`);
                }
            }

            // R√©initialiser les param√®tres
            async function resetSettings() {
                if (confirm("√ätes-vous s√ªr de vouloir r√©initialiser tous les param√®tres √† leurs valeurs par d√©faut ?")) {
                    const result = await window.pywebview.api.reset_settings_to_default();
                    if (result.status === 'success') {
                        alert(result.message);
                        await loadSettings();
                    } else {
                        alert(`Erreur: ${result.message}`);
                    }
                }
            }
            {% endif %}

            // --- NOUVEAU : Logique pour afficher/cacher les cl√©s API ---
            document.querySelectorAll('.toggle-password').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    const input = toggle.previousElementSibling;
                    if (input.type === 'password') {
                        input.type = 'text';
                        toggle.textContent = 'üôà';
                    } else {
                        input.type = 'password';
                        toggle.textContent = 'üëÅÔ∏è';
                    }
                });
            });

            // --- NOUVEAU : Logique d'authentification ---
            const loginForm = document.getElementById('login-form');
            const usernameInput = document.getElementById('username-input');
            const passwordInput = document.getElementById('password-input');
            const authBox = document.getElementById('auth-box');

            if (loginForm) {
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = usernameInput.value.trim();
                const password = passwordInput.value;

                if (!username || !password) {
                    showNotification("Identifiant et mot de passe requis.", 'error');
                    return;
                }

                const result = await window.pywebview.api.check_bunker_password(username, password);

                if (result.status === 'success') {
                    // Stocker le r√¥le de l'utilisateur pour une utilisation future
                    // La session est maintenant g√©r√©e c√¥t√© serveur. On recharge simplement la page.
                    alert('Connexion r√©ussie.');
                    window.location.href = '/terminaux.html';
                } else {
                    showNotification(result.message || 'Identifiants incorrects.', 'error');
                    authBox.classList.add('shake-effect');
                    passwordInput.value = '';
                    passwordInput.focus();
                    setTimeout(() => authBox.classList.remove('shake-effect'), 500);
                }
            });
            }

            const loginBackBtn = document.getElementById('login-back-btn');
            if (loginBackBtn) {
                loginBackBtn.addEventListener('click', () => {
                    window.location.href = '/terminaux.html';
                });
            }

            // --- NOUVEAU : Logique des boutons de s√©curit√© ---
            const clearCacheBtn = document.getElementById('clear-cache-btn');
            const killAppBtn = document.getElementById('kill-app-btn');
            const crashBtn = document.getElementById('crash-btn');

            if (clearCacheBtn) {
                clearCacheBtn.addEventListener('click', () => {
                    if (confirm("ATTENTION : Cette action va archiver votre dossier Bunker et r√©initialiser l'application √† son √©tat de premi√®re utilisation. Voulez-vous continuer ?")) {
                        alert("Archivage et r√©initialisation en cours... L'application va se fermer.");
                        window.pywebview.api.clearCache();
                    }
                });
            }

            if (killAppBtn) {
                killAppBtn.addEventListener('click', () => {
                    if (confirm("AVERTISSEMENT EXTR√äME : Cette action va tenter de supprimer COMPL√àTEMENT l'application et toutes ses donn√©es de votre syst√®me. Cette action est IRREVERSIBLE. √ätes-vous absolument certain ?")) {
                        alert("Proc√©dure d'auto-destruction enclench√©e. Adieu.");
                        window.pywebview.api.killApp();
                    }
                });
            }

            if (crashBtn) {
                crashBtn.addEventListener('click', () => {
                    if (confirm("AVERTISSEMENT FINAL : Cette action va simuler un crash syst√®me majeur, tenter de supprimer l'application et ses donn√©es, et terminer le processus brutalement. Utilisez cette option uniquement en cas de compromission critique. Continuer ?")) {
                        alert("CRASH IMMINENT...");
                        window.pywebview.api.crashApp();
                    }
                });
            }

            // --- Listeners pour la vue authentifi√©e ---
            const saveBtn = document.getElementById('save-btn');
            const resetBtn = document.getElementById('reset-btn');
            const backBtn = document.getElementById('back-btn');
            const logoutBtn = document.getElementById('logout-btn');

            if (saveBtn) saveBtn.addEventListener('click', saveSettings);
            if (resetBtn) resetBtn.addEventListener('click', resetSettings);
            if (backBtn) backBtn.addEventListener('click', () => { window.location.href = '/terminaux.html'; });
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    const result = await window.pywebview.api.logout();
                    if (result.status === 'success') {
                        alert('D√©connexion r√©ussie.');
                        window.location.reload(); // Recharge la page, qui affichera le formulaire de login
                    }
                });
            }

            // Attacher l'√©v√©nement de scroll et l'ex√©cuter une fois au chargement
            window.addEventListener('scroll', updateEraStyle, { passive: true });
            updateEraStyle();

            // Chargement initial
            {% if is_authenticated %}
            loadSettings();
            {% endif %}
        });
    </script>
</body>
</html>